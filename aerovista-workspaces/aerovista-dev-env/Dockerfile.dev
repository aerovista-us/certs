# syntax=docker/dockerfile:1.7
# NXCore Dev â€¢ unified toolchain for collaborators
# - Node.js 20 (corepack with pnpm/yarn)
# - Python 3.12 (pip, venv, pipx, poetry, uv)
# - Common build utils
# - Optional: ffmpeg, git, jq, ripgrep

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# Base packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl wget git git-lfs bash zsh locales tzdata \
    build-essential pkg-config unzip zip software-properties-common \
    python3 python3-dev python3-pip python3-venv python3-full \
    ffmpeg jq ripgrep openssh-client \
 && rm -rf /var/lib/apt/lists/*

# Node.js 20 LTS (via NodeSource)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
 && apt-get update && apt-get install -y nodejs \
 && npm --version && node --version

# Enable corepack for yarn/pnpm
RUN corepack enable \
 && corepack prepare pnpm@latest --activate \
 && corepack prepare yarn@stable --activate

# Python userland tools
RUN python3 -m pip install --upgrade pip setuptools wheel pipx \
 && pipx install poetry \
 && pipx install uv

# Create non-root user (dev) with home and zsh
RUN useradd -ms /bin/zsh dev \
 && usermod -aG sudo dev \
 && echo "dev ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/90-dev-nopasswd

USER dev
WORKDIR /workspace

# Shell goodies (minimal)
RUN echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.zshrc \
 && echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.bashrc \
 && echo 'eval "$(pyenv init - 2>/dev/null || true)"' >> ~/.zshrc

# Default command drops you into zsh
CMD ["/bin/zsh"]
