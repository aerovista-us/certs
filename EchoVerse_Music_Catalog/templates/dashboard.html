<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoVerse Music Catalog - AeroVista Studios</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%238a5fff;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%236c72cb;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Ctext x='50' y='60' font-family='Arial, sans-serif' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3E🎵%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%238a5fff;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%236c72cb;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Ctext x='50' y='60' font-family='Arial, sans-serif' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3E🎵%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #6c72cb 0%, #8a5fff 100%);
            --secondary-gradient: linear-gradient(135deg, #8a5fff 0%, #6c72cb 100%);
            --accent-gradient: linear-gradient(135deg, #8a5fff 0%, #6c72cb 100%);
            --dark-bg: #12122c;
            --dark-card-bg: #1a1a35;
            --dark-card-hover: #22223f;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: #a8a8c0;
            --text-accent: #8a5fff;
            --accent-color: #8a5fff;
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 16px 48px rgba(0, 0, 0, 0.2);
            --shadow-heavy: 0 24px 64px rgba(0, 0, 0, 0.3);
            --border-radius: 16px;
            --border-radius-lg: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --sidebar-width: 350px;
            --sidebar-collapsed-width: 60px;
            --header-height: 70px;
            --btn-primary-bg: #8a5fff;
            --btn-primary-hover: #9b76ff;
            --btn-secondary-bg: #2d2d50;
            --btn-secondary-hover: #3a3a64;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Modern scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(138, 95, 255, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(138, 95, 255, 0.8);
        }
        
        /* Header */
        .header {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 15px 0;
            box-shadow: var(--shadow-light);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            font-size: 2rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 4px rgba(138, 95, 255, 0.3));
        }
        
        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-accent);
            text-decoration: none;
        }
        
        .logo:hover .logo-icon {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
        
        .logo:hover .logo-text {
            filter: brightness(1.2);
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
            list-style: none;
        }
        
        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 50px;
            background: transparent;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .nav-links a.active {
            background: var(--glass-bg);
            color: var(--text-primary);
        }
        
        .nav-links a:hover {
            color: var(--text-primary);
            background: var(--glass-bg);
        }
        
        .user-profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0 30px;
        }
        
        .stat-card {
            background: var(--dark-card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            background: var(--dark-card-hover);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Quick Search */
        .quick-search {
            background: var(--dark-card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
        }
        
        .search-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-box {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: var(--transition);
        }
        
        .search-box:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(138, 95, 255, 0.1);
        }
        
        .search-box::placeholder {
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .btn {
            background: var(--btn-primary-bg);
            color: var(--text-primary);
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-width: 100px;
        }
        
        .btn:hover {
            background: var(--btn-primary-hover);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.secondary {
            background: var(--btn-secondary-bg);
            color: var(--text-secondary);
        }
        
        .btn.secondary:hover {
            background: var(--btn-secondary-hover);
            color: var(--text-primary);
        }
        
        .btn.small {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 60px;
        }
        
        .btn.icon-only {
            width: 36px;
            height: 36px;
            padding: 0;
            min-width: unset;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Loading states */
        .btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Enhanced hover effects */
        .album-card {
            transition: var(--transition);
        }
        
        .album-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-heavy);
        }
        
        .track-item {
            transition: var(--transition);
        }
        
        .track-item:hover {
            background: var(--glass-bg);
            transform: translateX(8px);
        }
        
        /* Search results indicator */
        .search-results {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-top: 8px;
            text-align: center;
            opacity: 0;
            transition: var(--transition);
        }
        
        .search-results.show {
            opacity: 1;
        }
        
        /* Filter Controls */
        .filter-controls {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-row:last-child {
            margin-bottom: 0;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 120px;
        }
        
        .filter-group label {
            font-size: 0.8rem;
            color: #b8b8b8;
            font-weight: 500;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            min-width: 100px;
        }
        
        .filter-group input[type="number"] {
            width: 80px;
        }
        
        .filter-btn, .view-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            margin-right: 8px;
        }
        
        .filter-btn:hover, .view-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .view-btn.active {
            background: rgba(102, 126, 234, 0.4);
            border-color: rgba(102, 126, 234, 0.6);
        }
        
        /* Work Order Builder */
        .work-order-builder {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
        }
        
        .work-order-builder h3 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        /* Enhanced Work Order System */
        .work-order-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            max-width: 1200px;
            height: 80vh;
            background: var(--dark-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-heavy);
            z-index: 10001;
            display: none;
            overflow: hidden;
        }
        
        .work-order-popup.active {
            display: flex;
            flex-direction: column;
        }
        
        .work-order-header {
            background: var(--glass-bg);
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .work-order-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .work-order-sidebar {
            width: 300px;
            background: var(--dark-card-bg);
            border-right: 1px solid var(--glass-border);
            padding: 20px;
            overflow-y: auto;
        }
        
        .work-order-main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .work-order-track-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .work-order-track-info {
            flex: 1;
        }
        
        .work-order-track-actions {
            display: flex;
            gap: 10px;
        }
        
        .metadata-editor {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .metadata-field {
            margin-bottom: 15px;
        }
        
        .metadata-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .rating-stars {
            display: flex;
            gap: 5px;
        }
        
        .rating-star {
            font-size: 20px;
            cursor: pointer;
            color: #666;
            transition: color 0.2s ease;
        }
        
        .rating-star.active {
            color: #ffd700;
        }
        
        .rating-star:hover {
            color: #ffd700;
        }
        
        .tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .tag {
            background: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .work-order-status {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #ff9800;
            color: white;
        }
        
        .status-in-progress {
            background: #2196f3;
            color: white;
        }
        
        .status-completed {
            background: #4caf50;
            color: white;
        }
        
        .work-order-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .selected-tracks {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            min-height: 50px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }
        
        .track-tag {
            background: rgba(102, 126, 234, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .remove-track {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .work-order-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            color: #b8b8b8;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Music Grid */
        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        /* Album Card */
        .album-card {
            background: var(--dark-card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .album-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            background: var(--dark-card-hover);
        }
        
        .album-header {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: transparent;
        }
        
        .album-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }
        
        .album-artist {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .album-cover {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #2d2d50 0%, #1a1a35 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 3rem;
            position: relative;
            overflow: hidden;
        }
        
        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .album-tracks {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 350px;
        }
        
        .tracks-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .track-count {
            text-align: center;
            padding: 5px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            margin-top: 10px;
        }
        
        .track-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background 0.2s ease;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .track-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .track-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .track-info {
            flex: 1;
            overflow: hidden;
        }
        
        .track-name {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-duration {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .track-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        
        .action-btn {
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: var(--text-secondary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: var(--btn-secondary-hover);
            color: var(--text-primary);
        }
        
        .action-btn.primary {
            background: rgba(138, 95, 255, 0.2);
            color: var(--accent-color);
        }
        
        .action-btn.primary:hover {
            background: rgba(138, 95, 255, 0.3);
        }
        
        /* View Modes */
        .music-grid.view-list {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .music-grid.view-list .album-card {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            height: auto;
            padding: 0;
        }
        
        .music-grid.view-list .album-cover {
            width: 80px;
            height: auto;
            flex-shrink: 0;
            border-radius: 0;
        }
        
        .music-grid.view-list .album-header {
            width: 200px;
            padding: 15px;
            text-align: left;
            border-bottom: none;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .music-grid.view-list .album-tracks {
            flex: 1;
            max-height: none;
            padding: 10px 15px;
        }
        
        .music-grid.view-compact {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .music-grid.view-compact .album-card {
            padding: 0;
        }
        
        .music-grid.view-compact .album-cover {
            height: 120px;
        }
        
        .music-grid.view-compact .album-tracks {
            max-height: 200px;
        }
        
        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .lazy-image[src] {
            opacity: 1;
        }
        
        /* Lyrics Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: white;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 80px;
            color: #b8b8b8;
            font-size: 1.2rem;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Audio Player */
        .audio-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .audio-player.active {
            transform: translateY(0);
        }
        
        /* Loading spinner animation */
        .loading-spinner {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .player-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
        }
        
        .player-cover {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            overflow: hidden;
        }
        
        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .track-details {
            flex: 1;
        }
        
        .track-title {
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
        }
        
        .track-artist {
            font-size: 0.9rem;
            color: #b8b8b8;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            justify-content: center;
        }
        
        .control-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .control-btn.play-pause {
            background: #667eea;
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
        }
        
        .control-btn.play-pause:hover {
            background: #5a6fd8;
        }
        
        .progress-container {
            flex: 1;
            max-width: 400px;
            position: relative;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #b8b8b8;
            margin-top: 5px;
        }
        
        .player-volume {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        
        .volume-progress {
            height: 100%;
            background: #667eea;
            border-radius: 2px;
            width: 70%;
        }
        
        /* Spectrum Analyzer */
        .spectrum-analyzer {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 40px;
            min-width: 200px;
            margin: 0 20px;
        }
        
        .spectrum-analyzer.active {
            display: flex;
        }
        
        .spectrum-bar {
            width: 4px;
            background: linear-gradient(to top, #8a5fff, #667eea);
            border-radius: 2px;
            transition: height 0.1s ease;
            min-height: 2px;
        }
        
        .close-player {
            background: none;
            border: none;
            color: #b8b8b8;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.2s ease;
        }
        
        .close-player:hover {
            color: #ffffff;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
                padding: 20px 0;
            }
            
            .logo-icon {
                font-size: 2.5rem;
            }
            
            .logo-text {
                font-size: 2rem;
            }
            
            .nav-links {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                justify-content: center;
            }
            
            .nav-links a {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                margin: 32px 0;
            }
            
            .stat-card {
                padding: 24px 20px;
            }
            
            .stat-number {
                font-size: 2.5rem;
            }
            
            .search-section {
                flex-direction: column;
                gap: 16px;
            }
            
            .search-box {
                width: 100%;
            }
            
            .btn {
                padding: 14px 24px;
                font-size: 14px;
            }
            
            .work-order-form {
                grid-template-columns: 1fr;
            }
            
            .music-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .album-card {
                margin-bottom: 20px;
            }
            
            .filter-controls {
                padding: 20px;
            }
            
            .filter-row {
                flex-direction: column;
                gap: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 20px 16px;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .nav-links {
                flex-direction: column;
                width: 100%;
            }
            
            .nav-links a {
                text-align: center;
            }
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: var(--dark-card-bg);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 20px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .sidebar-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-close:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-close svg {
            width: 16px;
            height: 16px;
        }
        
        .sidebar-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.2s ease;
            border: none;
            box-shadow: var(--shadow-medium);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .sidebar-toggle:hover {
            transform: scale(1.05);
            background: var(--btn-primary-hover);
            box-shadow: var(--shadow-large);
        }
        
        .sidebar-toggle:active {
            transform: scale(0.95);
            transition: all 0.1s ease;
        }
        
        .sidebar-toggle svg {
            width: 24px;
            height: 24px;
        }
        
        .sidebar-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-tab {
            padding: 12px 8px;
            flex: 1;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
            position: relative;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-width: 60px;
        }
        
        .sidebar-tab .tab-text {
            display: none;
        }
        
        .sidebar-tab.active {
            color: var(--text-primary);
            background: rgba(138, 95, 255, 0.1);
        }
        
        .sidebar-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent-color);
        }
        
        .sidebar-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-tab svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-section {
            margin-bottom: 20px;
        }
        
        .tab-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-accent);
        }
        
        /* Adjust main content when sidebar is active */
        .main-content {
            transition: margin-right 0.3s ease;
        }
        
        .main-content.sidebar-active {
            margin-right: var(--sidebar-width);
        }
        
        /* Responsive sidebar */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }
            
            .main-content.sidebar-active {
                margin-right: 0;
            }
        }
        
        /* Enhanced Form Controls */
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: var(--transition);
        }
        
        .form-control option {
            background: var(--dark-card-bg);
            color: var(--text-primary);
        }
        
        select.form-control {
            background: var(--dark-card-bg);
            color: var(--text-primary);
        }
        
        select.form-control option {
            background: var(--dark-card-bg);
            color: var(--text-primary);
        }
        
        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(138, 95, 255, 0.1);
        }
        
        .form-control::placeholder {
            color: var(--text-secondary);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }
        
        .range-control {
            width: 100%;
            accent-color: var(--accent-color);
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 5px;
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        /* Additional form styling */
        .year-range-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .year-input {
            width: 100px;
        }
        
        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .view-modes {
            display: flex;
            gap: 10px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .sidebar-search-results {
            margin-top: 15px;
        }
        
        .work-order-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .filter-actions {
            margin-top: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .conversion-result {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 13px;
        }
        
        .path-examples {
            list-style-type: none;
            padding-left: 0;
        }
        
        .path-examples li {
            margin-bottom: 8px;
        }
        
        .path-examples code {
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">🎵</div>
                    <div class="logo-text">EchoVerse</div>
                </div>
                <nav class="nav-links">
                    <a href="#music-catalog" class="nav-link">🎵 Music Catalog</a>
                    <a href="/gallery" class="nav-link">🖼️ Album Art Gallery</a>
                    <a href="/images" class="nav-link">🖼️ All Images</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" title="Open Sidebar (S)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Tools & Settings</div>
            <button class="sidebar-close" id="sidebarClose" title="Close Sidebar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            </div>
        
        <div class="sidebar-tabs">
            <div class="sidebar-tab" data-tab="search" title="Search Music">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                    <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="tab-text">Search</span>
            </div>
            <div class="sidebar-tab" data-tab="filter" title="Filter & Sort">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 6H21M7 12H17M10 18H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="tab-text">Filter</span>
            </div>
            <div class="sidebar-tab active" data-tab="workorders" title="Work Orders">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="tab-text">Orders</span>
            </div>
            <div class="sidebar-tab" data-tab="pathtool" title="Path Tool">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 7V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V7M3 7L5 21H19L21 7M3 7H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="tab-text">Path</span>
            </div>
            <div class="sidebar-tab" data-tab="settings" title="Settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                    <path d="M19.4 15C19.2669 15.3016 19.2272 15.6362 19.286 15.9606C19.3448 16.285 19.4995 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71C19.6043 19.896 19.3837 20.0435 19.1409 20.1441C18.8981 20.2448 18.6378 20.2966 18.375 20.2966C18.1122 20.2966 17.8519 20.2448 17.6091 20.1441C17.3663 20.0435 17.1457 19.896 16.96 19.71L16.9 19.65C16.6643 19.4195 16.365 19.2648 16.0406 19.206C15.7162 19.1472 15.3816 19.1869 15.08 19.32C14.7842 19.4468 14.532 19.6572 14.3543 19.9255C14.1766 20.1938 14.0813 20.5082 14.08 20.83V21C14.08 21.5304 13.8693 22.0391 13.4942 22.4142C13.1191 22.7893 12.6104 23 12.08 23C11.5496 23 11.0409 22.7893 10.6658 22.4142C10.2907 22.0391 10.08 21.5304 10.08 21V20.91C10.0723 20.579 9.96512 20.2573 9.77251 19.9887C9.5799 19.7201 9.31074 19.5166 9 19.4C8.69838 19.2669 8.36381 19.2272 8.03941 19.286C7.71502 19.3448 7.41568 19.4995 7.18 19.73L7.12 19.79C6.93425 19.976 6.71368 20.1235 6.47088 20.2241C6.22808 20.3248 5.96783 20.3766 5.705 20.3766C5.44217 20.3766 5.18192 20.3248 4.93912 20.2241C4.69632 20.1235 4.47575 19.976 4.29 19.79C4.10405 19.6043 3.95653 19.3837 3.85588 19.1409C3.75523 18.8981 3.70343 18.6378 3.70343 18.375C3.70343 18.1122 3.75523 17.8519 3.85588 17.6091C3.95653 17.3663 4.10405 17.1457 4.29 16.96L4.35 16.9C4.58054 16.6643 4.73519 16.365 4.794 16.0406C4.85282 15.7162 4.81312 15.3816 4.68 15.08C4.55324 14.7842 4.34276 14.532 4.07447 14.3543C3.80618 14.1766 3.49179 14.0813 3.17 14.08H3C2.46957 14.08 1.96086 13.8693 1.58579 13.4942C1.21071 13.1191 1 12.6104 1 12.08C1 11.5496 1.21071 11.0409 1.58579 10.6658C1.96086 10.2907 2.46957 10.08 3 10.08H3.09C3.42099 10.0723 3.742 9.96512 4.01062 9.77251C4.27925 9.5799 4.48278 9.31074 4.6 9C4.73312 8.69838 4.77282 8.36381 4.714 8.03941C4.65519 7.71502 4.50054 7.41568 4.27 7.18L4.21 7.12C4.02405 6.93425 3.87653 6.71368 3.77588 6.47088C3.67523 6.22808 3.62343 5.96783 3.62343 5.705C3.62343 5.44217 3.67523 5.18192 3.77588 4.93912C3.87653 4.69632 4.02405 4.47575 4.21 4.29C4.39575 4.10405 4.61632 3.95653 4.85912 3.85588C5.10192 3.75523 5.36217 3.70343 5.625 3.70343C5.88783 3.70343 6.14808 3.75523 6.39088 3.85588C6.63368 3.95653 6.85425 4.10405 7.04 4.29L7.1 4.35C7.33568 4.58054 7.63502 4.73519 7.95941 4.794C8.28381 4.85282 8.61838 4.81312 8.92 4.68H9C9.29577 4.55324 9.54802 4.34276 9.72569 4.07447C9.90337 3.80618 9.99872 3.49179 10 3.17V3C10 2.46957 10.2107 1.96086 10.5858 1.58579C10.9609 1.21071 11.4696 1 12 1C12.5304 1 13.0391 1.21071 13.4142 1.58579C13.7893 1.96086 14 2.46957 14 3V3.09C14.0013 3.41179 14.0966 3.72618 14.2743 3.99447C14.452 4.26276 14.7042 4.47324 15 4.6C15.3016 4.73312 15.6362 4.77282 15.9606 4.714C16.285 4.65519 16.5843 4.50054 16.82 4.27L16.88 4.21C17.0657 4.02405 17.2863 3.87653 17.5291 3.77588C17.7719 3.67523 18.0322 3.62343 18.295 3.62343C18.5578 3.62343 18.8181 3.67523 19.0609 3.77588C19.3037 3.87653 19.5243 4.02405 19.71 4.21C19.896 4.39575 20.0435 4.61632 20.1441 4.85912C20.2448 5.10192 20.2966 5.36217 20.2966 5.625C20.2966 5.88783 20.2448 6.14808 20.1441 6.39088C20.0435 6.63368 19.896 6.85425 19.71 7.04L19.65 7.1C19.4195 7.33568 19.2648 7.63502 19.206 7.95941C19.1472 8.28381 19.1869 8.61838 19.32 8.92V9C19.4468 9.29577 19.6572 9.54802 19.9255 9.72569C20.1938 9.90337 20.5082 9.99872 20.83 10H21C21.5304 10 22.0391 10.2107 22.4142 10.5858C22.7893 10.9609 23 11.4696 23 12C23 12.5304 22.7893 13.0391 22.4142 13.4142C22.0391 13.7893 21.5304 14 21 14H20.91C20.5882 14.0013 20.2738 14.0966 20.0055 14.2743C19.7372 14.452 19.5268 14.7042 19.4 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="tab-text">Settings</span>
            </div>
        </div>
        
        <div class="sidebar-content">
            <!-- Search Tab -->
            <div class="tab-content" id="search-tab">
                <div class="tab-section">
                    <div class="tab-section-title">Search Music</div>
                    <div class="form-group">
                        <input type="text" class="search-box" id="sidebarSearchBox" placeholder="Search albums, artists, tracks...">
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="searchCatalog()">Search</button>
                <button class="btn secondary" onclick="clearSearch()">Clear</button>
                    </div>
                    <div id="sidebarSearchResults" class="search-results sidebar-search-results"></div>
            </div>
            
                <div class="tab-section">
                    <div class="tab-section-title">Recent Searches</div>
                    <div id="recentSearches" class="recent-searches">
                        <div class="empty-state">No recent searches</div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Tab -->
            <div class="tab-content" id="filter-tab">
                <div class="tab-section">
                    <div class="tab-section-title">Sort Options</div>
                    <div class="form-group">
                        <label>Sort By</label>
                        <select id="sidebarSortBy" class="form-control" aria-label="Sort by field">
                            <option value="album">Album Name</option>
                            <option value="artist">Artist</option>
                            <option value="year">Year</option>
                            <option value="genre">Genre</option>
                            <option value="duration">Duration</option>
                            <option value="size">File Size</option>
                            <option value="track_count">Track Count</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Order</label>
                        <select id="sidebarSortOrder" class="form-control" aria-label="Sort order">
                            <option value="asc">A-Z / Low-High</option>
                            <option value="desc">Z-A / High-Low</option>
                        </select>
                    </div>
                    </div>
                    
                <div class="tab-section">
                    <div class="tab-section-title">Group & Filter</div>
                    <div class="form-group">
                        <label>Group By</label>
                        <select id="sidebarGroupBy" class="form-control" aria-label="Group by field">
                            <option value="none">No Grouping</option>
                            <option value="artist">Artist</option>
                            <option value="year">Year</option>
                            <option value="genre">Genre</option>
                            <option value="decade">Decade</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Genre Filter</label>
                        <select id="sidebarGenreFilter" class="form-control" aria-label="Filter by genre">
                            <option value="">All Genres</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year Range</label>
                        <div class="year-range-inputs">
                            <input type="number" id="sidebarYearFrom" placeholder="From" min="1900" max="2030" class="form-control year-input">
                        <span>-</span>
                            <input type="number" id="sidebarYearTo" placeholder="To" min="1900" max="2030" class="form-control year-input">
                    </div>
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <select id="sidebarDurationFilter" class="form-control" aria-label="Filter by duration">
                            <option value="">Any Length</option>
                            <option value="short">Short (< 3 min)</option>
                            <option value="medium">Medium (3-5 min)</option>
                            <option value="long">Long (> 5 min)</option>
                        </select>
                    </div>
                </div>
                
                <div class="tab-section">
                    <div class="tab-section-title">Quick Filters</div>
                    <div class="quick-filters">
                        <button class="btn small" onclick="quickFilter('recent')">🆕 Recent</button>
                        <button class="btn small" onclick="quickFilter('favorites')">⭐ Favorites</button>
                        <button class="btn small" onclick="quickFilter('unplayed')">⏸️ Unplayed</button>
                        <button class="btn small" onclick="quickFilter('longest')">⏱️ Longest</button>
                    </div>
                    </div>
                    
                <div class="tab-section">
                    <div class="tab-section-title">View Mode</div>
                    <div class="view-modes">
                        <button class="btn small active" onclick="setViewMode('grid')">📱 Grid</button>
                        <button class="btn small" onclick="setViewMode('list')">📋 List</button>
                        <button class="btn small" onclick="setViewMode('compact')">🔲 Compact</button>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn" onclick="applyFilters()">Apply Filters</button>
                    <button class="btn secondary" onclick="resetFilters()">Reset</button>
                </div>
            </div>
            
            <!-- Work Orders Tab -->
            <div class="tab-content active" id="workorders-tab">
                <div class="tab-section">
                    <div class="tab-section-title">Work Order Builder</div>
                <div class="selected-tracks" id="selectedTracks">
                    <span style="color: #888;">Select tracks to add to work order...</span>
                </div>
                
                <form class="work-order-form" id="workOrderForm">
                    <div class="form-group">
                        <label for="workOrderType">Work Order Type</label>
                            <select id="workOrderType" class="form-control" required aria-label="Work order type">
                            <option value="">Select type...</option>
                            <option value="playlist">Create Playlist</option>
                            <option value="new_album">New Album Production</option>
                            <option value="remix">Remix Project</option>
                            <option value="reference">Reference Material</option>
                            <option value="mastering">Mastering Project</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="workOrderTitle">Title</label>
                            <input type="text" id="workOrderTitle" class="form-control" placeholder="Work order title..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="workOrderDescription">Description</label>
                            <textarea id="workOrderDescription" class="form-control" placeholder="Describe the work to be done..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="workOrderPriority">Priority</label>
                            <select id="workOrderPriority" class="form-control" aria-label="Work order priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </form>
                
                    <div class="work-order-buttons">
                    <button class="btn" onclick="createWorkOrder()" id="createWorkOrderBtn" disabled>
                        📋 Create Work Order
                    </button>
                    <button class="btn secondary" onclick="exportWorkOrders()">
                        📤 Export All Work Orders
                    </button>
                    <button class="btn secondary" onclick="openWorkOrderPopup()">
                        🚀 Enhanced Work Orders
                    </button>
                </div>
            </div>
            </div>
            
            <!-- Path Tool Tab -->
            <div class="tab-content" id="pathtool-tab">
                <div class="tab-section">
                    <div class="tab-section-title">Tailscale Path Conversion</div>
                    <div class="form-group">
                        <label for="inputPath">Input File Path</label>
                        <textarea id="inputPath" rows="3" class="form-control" 
                            placeholder="Enter file path (e.g., M:\Albums\artist\track.mp3)"></textarea>
                    </div>
                    <button id="convertPathBtn" class="btn" style="margin-top: 10px;">Convert Path</button>
                    
                    <div class="result-container" style="margin-top: 15px;">
                        <div class="tab-section-title">Conversion Result</div>
                        <div id="conversionResult" class="conversion-result">
                            <p>Enter a path above and click "Convert Path" to see the Tailscale URL.</p>
                        </div>
                    </div>
                    
                    <div class="example-paths" style="margin-top: 15px;">
                        <div class="tab-section-title">Example Paths</div>
                        <ul class="path-examples">
                            <li><code>M:\Albums\artist\track.mp3</code></li>
                            <li><code>\\EchoVerse_Music\Albums\artist\track.mp3</code></li>
                            <li><code>\\envy2-0\EchoVerse_Music\Albums\artist\track.mp3</code></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div class="tab-content" id="settings-tab">
                <div class="tab-section">
                    <div class="tab-section-title">Tailscale Configuration</div>
                    <div id="tailscaleConfigForm">
                        <div class="form-group">
                            <label for="tailscaleDomain">Tailscale Full URL</label>
                            <input type="text" id="tailscaleDomain" class="form-control" placeholder="e.g., https://aerocoreos.tail79107c.ts.net/echoverse/Albums/" aria-label="Tailscale domain URL">
                            <small>Include the full URL with https:// prefix and trailing slash</small>
                        </div>
                        <div class="form-group hidden">
                            <label for="tailscaleMusicPath">Music Path (Not Used)</label>
                            <input type="text" id="tailscaleMusicPath" class="form-control" value="" aria-hidden="true">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="tailscaleEnabled"> 
                                <span>Enable Tailscale Streaming</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="tailscaleFallback"> 
                                <span>Enable Fallback to Direct Streaming</span>
                            </label>
                        </div>
                        <button id="saveConfigBtn" class="btn">Save Configuration</button>
                    </div>
                    <div id="configStatus" style="margin-top: 10px;"></div>
                </div>
                
                <div class="tab-section">
                    <div class="tab-section-title">Interface Settings</div>
                    <div class="form-group">
                        <label for="themeSelect">Theme</label>
                        <select id="themeSelect" class="form-control" aria-label="Theme selection">
                            <option value="dark">Dark Theme (Default)</option>
                            <option value="light">Light Theme</option>
                            <option value="contrast">High Contrast</option>
                            <option value="system">Use System Preference</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fontSizeSelect">Font Size</label>
                        <select id="fontSizeSelect" class="form-control" aria-label="Font size selection">
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium (Default)</option>
                            <option value="large">Large</option>
                            <option value="x-large">Extra Large</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="animationsEnabled" checked> 
                            <span>Enable Animations</span>
                        </label>
                    </div>
                    <button id="saveInterfaceSettings" class="btn">Save Interface Settings</button>
                    <button id="openThemeCustomizer" class="btn" style="margin-top: 10px; background: var(--accent-color);">🎨 Customize Theme Colors</button>
                </div>
                
                <div class="tab-section">
                    <div class="tab-section-title">Player Settings</div>
                    <div class="form-group">
                        <label for="defaultVolumeRange">Default Volume</label>
                        <input type="range" id="defaultVolumeRange" min="0" max="100" value="70" class="range-control">
                        <div class="range-labels">
                            <span>0%</span>
                            <span id="volumeValue">70%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="autoplayEnabled"> 
                            <span>Enable Autoplay</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="continuousPlayback" checked> 
                            <span>Enable Continuous Playback</span>
                        </label>
                    </div>
                    <button id="savePlayerSettings" class="btn">Save Player Settings</button>
                </div>
                
                <div class="tab-section">
                    <div class="tab-section-title">About</div>
                    <p>EchoVerse Music Catalog v2.0</p>
                    <p>© 2025 AeroVista Studios</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="container main-content" id="mainContent">
        <!-- Statistics -->
        <section class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalAlbums">{{ total_albums }}</div>
                <div class="stat-label">Albums</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalTracks">{{ total_tracks }}</div>
                <div class="stat-label">Tracks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalSize">{{ "%.2f"|format(total_size_gb) }}</div>
                <div class="stat-label">GB Total</div>
            </div>
        </section>

        <!-- Quick Search Bar -->
        <section class="quick-search">
            <div class="search-section">
                <input type="text" class="search-box" id="searchBox" placeholder="Search albums, artists, tracks...">
                <button class="btn" onclick="searchCatalog()">🔍 Search</button>
                <button class="btn secondary" onclick="clearSearch()">Clear</button>
                <div id="searchResults" class="search-results"></div>
            </div>
        </section>

        <!-- Music Catalog -->
        <section id="catalog">
            <h2 style="text-align: center; margin: 40px 0; color: #667eea;">🎵 Music Catalog</h2>
            <div class="music-grid" id="musicGrid">
                <div class="loading">Loading music catalog...</div>
            </div>
        </section>


    </main>

    <!-- Lyrics Modal -->
    <div id="lyricsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLyricsModal()">&times;</span>
            <h3 id="modalTitle">Lyrics</h3>
            <div id="modalContent">        </div>
    </div>
</div>

<!-- Enhanced Work Order Popup -->
<div class="work-order-popup" id="workOrderPopup">
    <div class="work-order-header">
        <h3>🎵 Enhanced Work Order Manager</h3>
        <div class="work-order-actions">
            <button class="btn secondary" onclick="closeWorkOrderPopup()">✕ Close</button>
            <button class="btn" onclick="saveWorkOrder()">💾 Save Work Order</button>
        </div>
    </div>
    
    <div class="work-order-content">
        <div class="work-order-sidebar">
            <h4>📋 Work Order Details</h4>
            <div class="metadata-editor">
                <div class="metadata-field">
                    <label>Work Order Type</label>
                    <select id="popupWorkOrderType" class="form-control">
                        <option value="playlist">Create Playlist</option>
                        <option value="new_album">New Album Production</option>
                        <option value="remix">Remix Project</option>
                        <option value="reference">Reference Material</option>
                        <option value="mastering">Mastering Project</option>
                    </select>
                </div>
                
                <div class="metadata-field">
                    <label>Title</label>
                    <input type="text" id="popupWorkOrderTitle" class="form-control" placeholder="Work order title...">
                </div>
                
                <div class="metadata-field">
                    <label>Description</label>
                    <textarea id="popupWorkOrderDescription" class="form-control" placeholder="Describe the work..."></textarea>
                </div>
                
                <div class="metadata-field">
                    <label>Priority</label>
                    <select id="popupWorkOrderPriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <div class="metadata-field">
                    <label>Status</label>
                    <div class="work-order-status">
                        <span class="status-badge status-pending" onclick="setWorkOrderStatus('pending')">Pending</span>
                        <span class="status-badge status-in-progress" onclick="setWorkOrderStatus('in-progress')">In Progress</span>
                        <span class="status-badge status-completed" onclick="setWorkOrderStatus('completed')">Completed</span>
                    </div>
                </div>
            </div>
            
            <h4>📊 Statistics</h4>
            <div class="metadata-editor">
                <div class="metadata-field">
                    <label>Total Tracks: <span id="workOrderTrackCount">0</span></label>
                </div>
                <div class="metadata-field">
                    <label>Total Duration: <span id="workOrderDuration">0:00</span></label>
                </div>
                <div class="metadata-field">
                    <label>Average Rating: <span id="workOrderAvgRating">0.0</span></label>
                </div>
            </div>
        </div>
        
        <div class="work-order-main">
            <h4>🎵 Selected Tracks</h4>
            <div id="workOrderTracksList" class="work-order-tracks-list">
                <div style="text-align: center; color: #888; padding: 40px;">
                    No tracks selected. Right-click on tracks to add them to this work order.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audio Player -->
    <div class="audio-player" id="audioPlayer">
        <div class="player-content">
            <div class="player-info">
                <div class="player-cover" id="playerCover">
                    <div>🎵</div>
                </div>
                <div class="track-details">
                    <div class="track-title" id="playerTitle">No track selected</div>
                    <div class="track-artist" id="playerArtist">Select a track to play</div>
                </div>
            </div>
            
            <div class="player-controls">
                <button class="control-btn" id="prevBtn">⏮️</button>
                <button class="control-btn play-pause" id="playPauseBtn">▶️</button>
                <button class="control-btn" id="nextBtn">⏭️</button>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
            </div>
            
            <div class="player-volume">
                <span>🔊</span>
                <div class="volume-slider" id="volumeSlider">
                    <div class="volume-progress" id="volumeProgress"></div>
                </div>
            </div>
            
            <!-- Spectrum Analyzer -->
            <div class="spectrum-analyzer" id="spectrumAnalyzer">
                <!-- Spectrum bars will be created dynamically -->
            </div>
            
            <button class="close-player" id="closePlayer">✕</button>
        </div>
        
        <audio id="audioElement" preload="metadata"></audio>
    </div>

    <script src="persistent_audio.js"></script>
    <script>
        let catalogData = [];
        let selectedTracks = [];
        let currentSearchResults = [];

        // Load catalog on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize with performance optimizations
            const initFunction = () => {
                loadCatalog();
                populateFilterOptions();
                initializeLazyLoading();
                initializeRealTimeSearch();
                addLoadingStates();
                initAudioPlayer();
                initializePersistentAudio();
            };
            
            // Use requestIdleCallback for better performance, fallback to setTimeout
            if (window.requestIdleCallback) {
                requestIdleCallback(initFunction);
            } else {
                setTimeout(initFunction, 0);
            }
        });
        
        // Enhanced real-time search functionality
        function initializeRealTimeSearch() {
            const searchBox = document.getElementById('searchBox');
            let searchTimeout;
            
            searchBox.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(this.value);
                }, 300); // Debounce search
            });
            
            // Add search suggestions
            searchBox.addEventListener('focus', function() {
                showSearchSuggestions();
            });
            
            searchBox.addEventListener('blur', function() {
                setTimeout(() => hideSearchSuggestions(), 200);
            });
        }
        
        function performSearch(query) {
            if (!query.trim()) {
                displayCatalog(groupByAlbum(catalogData));
                return;
            }
            
            const filteredData = catalogData.filter(track => {
                const searchText = `${track.album} ${track.artist} ${track.track} ${track.genre}`.toLowerCase();
                return searchText.includes(query.toLowerCase());
            });
            
            displayCatalog(groupByAlbum(filteredData));
            updateSearchResults(filteredData.length);
        }
        
        function showSearchSuggestions() {
            // Implementation for search suggestions
            console.log('Showing search suggestions');
        }
        
        function hideSearchSuggestions() {
            // Implementation for hiding search suggestions
            console.log('Hiding search suggestions');
        }
        
        function updateSearchResults(count) {
            const resultsInfo = document.getElementById('searchResults');
            if (resultsInfo) {
                if (count > 0) {
                    resultsInfo.textContent = `${count} results found`;
                    resultsInfo.classList.add('show');
                } else {
                    resultsInfo.classList.remove('show');
                }
            }
        }
        
        // Enhanced loading states
        function addLoadingStates() {
            // Add loading animation to buttons
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!this.classList.contains('loading')) {
                        this.classList.add('loading');
                        const originalText = this.textContent;
                        this.textContent = 'Loading...';
                        
                        setTimeout(() => {
                            this.classList.remove('loading');
                            this.textContent = originalText;
                        }, 1000);
                    }
                });
            });
        }

        async function loadCatalog() {
            try {
                // Check for cached data first
                const cachedData = localStorage.getItem('echoverse_catalog_cache');
                const cacheTimestamp = localStorage.getItem('echoverse_catalog_timestamp');
                const now = Date.now();
                const cacheExpiry = 5 * 60 * 1000; // 5 minutes
                
                if (cachedData && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
                    console.log('📦 Using cached catalog data');
                    const data = JSON.parse(cachedData);
                    catalogData = data.tracks;
                    currentSearchResults = data.tracks;
                    displayCatalog(data.albums);
                    return;
                }
                
                console.log('🌐 Fetching fresh catalog data');
                const response = await fetch('/api/catalog');
                const data = await response.json();
                catalogData = data.tracks;
                currentSearchResults = data.tracks;
                
                // Cache the data
                localStorage.setItem('echoverse_catalog_cache', JSON.stringify(data));
                localStorage.setItem('echoverse_catalog_timestamp', now.toString());
                
                displayCatalog(data.albums);
            } catch (error) {
                console.error('Error loading catalog:', error);
                
                // Try to use cached data as fallback
                const cachedData = localStorage.getItem('echoverse_catalog_cache');
                if (cachedData) {
                    console.log('📦 Using cached data as fallback');
                    const data = JSON.parse(cachedData);
                    catalogData = data.tracks;
                    currentSearchResults = data.tracks;
                    displayCatalog(data.albums);
                    showNotification('Using cached data (offline mode)', 'warning');
                } else {
                    document.getElementById('musicGrid').innerHTML = '<div class="loading">Error loading catalog</div>';
                }
            }
        }

        function displayCatalog(albums) {
            const container = document.getElementById('musicGrid');
            
            if (Object.keys(albums).length === 0) {
                container.innerHTML = '<div class="loading">No albums found</div>';
                return;
            }

            container.innerHTML = Object.values(albums).map(album => createAlbumCard(album)).join('');
            
            // Refresh lazy loading for new images
            refreshLazyLoading();
        }

        function createAlbumCard(album) {
            const coverImage = album.cover ? 
                `<img data-src="/api/album-art/${encodeURIComponent(album.album)}" 
                      alt="${album.album}" 
                      class="lazy-image"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />` : 
                `<div style="display: none;"></div>`;
            
            const fallbackCover = `<div style="display: flex; align-items: center; justify-content: center; font-size: 3rem;">🎵</div>`;
            
            return `
                <div class="album-card">
                    <div class="album-header">
                        <div class="album-title">${album.album}</div>
                        <div class="album-artist">${album.artist}</div>
                    </div>
                    
                    <div class="album-cover">
                        ${coverImage}
                        ${fallbackCover}
                    </div>
                    
                    <div class="album-tracks">
                        <div class="tracks-container">
                        ${album.tracks.map(track => createTrackItem(track)).join('')}
                        </div>
                        <div class="track-count">${album.tracks.length} Tracks</div>
                    </div>
                </div>
            `;
        }

        function createTrackItem(track) {
            // Escape special characters for JavaScript strings
            const escapeStr = str => str ? str.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
            const trackName = escapeStr(track.track);
            const albumName = escapeStr(track.album);
            const artistName = escapeStr(track.artist);
            const filePath = escapeStr(track.file_path);
            const tailscaleUrl = escapeStr(track.tailscale_echoverse_url);
            const apiAudioPathparam = escapeStr(track.api_audio_pathparam);
            
            // Track URL construction for playback
            const encodedPath = filePath ? encodeURIComponent(filePath) : '';
            const fallbackApiUrl = encodedPath ? `/api/audio/${encodedPath}?use_tailscale=true` : '';
            const preferredUrl = tailscaleUrl || apiAudioPathparam || fallbackApiUrl;
            
            return `
                <div class="track-item" 
                     onclick="toggleTrackSelection('${trackName}', '${albumName}', '${artistName}')"
                     data-track-id="${track.id || ''}"
                     data-album-id="${track.album_id || ''}"
                     data-artist-id="${track.artist_id || ''}"
                     data-track-url="${preferredUrl}"
                     data-track-title="${trackName}"
                     data-artist-name="${artistName}"
                     data-album-name="${albumName}">
                    <div class="track-info">
                        <div class="track-name">${track.track}</div>
                        <div class="track-duration">${track.duration || '0:00'}</div>
                    </div>
                    <div class="track-actions">
                        <button class="action-btn primary" onclick="event.stopPropagation(); addToWorkOrder('${trackName}', '${albumName}', '${artistName}')">
                            +
                        </button>
                        ${track.lyrics_file ? `<button class="action-btn" onclick="event.stopPropagation(); showLyrics('${escapeStr(track.lyrics_file)}', '${trackName}')">📖</button>` : ''}
                        <button class="action-btn" onclick="event.stopPropagation(); playTrackByUrl('${preferredUrl}', '${trackName}', '${artistName}', '${albumName}', '${track.id || ''}')">▶️</button>
                    </div>
                </div>
            `;
        }

        function toggleTrackSelection(trackName, albumName, artistName) {
            const trackId = `${trackName}-${albumName}`;
            const existingIndex = selectedTracks.findIndex(t => t.id === trackId);
            
            if (existingIndex >= 0) {
                selectedTracks.splice(existingIndex, 1);
            } else {
                selectedTracks.push({
                    id: trackId,
                    track: trackName,
                    album: albumName,
                    artist: artistName
                });
            }
            
            updateSelectedTracksDisplay();
            updateWorkOrderButton();
        }

        function addToWorkOrder(trackName, albumName, artistName) {
            const trackId = `${trackName}-${albumName}`;
            const existingIndex = selectedTracks.findIndex(t => t.id === trackId);
            
            if (existingIndex < 0) {
                selectedTracks.push({
                    id: trackId,
                    track: trackName,
                    album: albumName,
                    artist: artistName
                });
                
                updateSelectedTracksDisplay();
                updateWorkOrderButton();
            }
        }

        function updateSelectedTracksDisplay() {
            const container = document.getElementById('selectedTracks');
            
            if (selectedTracks.length === 0) {
                container.innerHTML = '<span style="color: #888;">Select tracks to add to work order...</span>';
                return;
            }
            
            container.innerHTML = selectedTracks.map(track => `
                <div class="track-tag">
                    ${track.track} (${track.album})
                    <button class="remove-track" onclick="removeTrack('${track.id}')">×</button>
                </div>
            `).join('');
        }

        function removeTrack(trackId) {
            selectedTracks = selectedTracks.filter(t => t.id !== trackId);
            updateSelectedTracksDisplay();
            updateWorkOrderButton();
        }

        function updateWorkOrderButton() {
            const btn = document.getElementById('createWorkOrderBtn');
            btn.disabled = selectedTracks.length === 0;
        }

        async function createWorkOrder() {
            const form = document.getElementById('workOrderForm');
            const formData = new FormData(form);
            
            const workOrder = {
                type: document.getElementById('workOrderType').value,
                title: document.getElementById('workOrderTitle').value,
                description: document.getElementById('workOrderDescription').value,
                priority: document.getElementById('workOrderPriority').value,
                tracks: selectedTracks,
                status: 'pending'
            };
            
            try {
                const response = await fetch('/api/work-orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workOrder)
                });
                
                if (response.ok) {
                    alert('Work order created successfully!');
                    selectedTracks = [];
                    updateSelectedTracksDisplay();
                    updateWorkOrderButton();
                    form.reset();
                } else {
                    alert('Error creating work order');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating work order');
            }
        }

        async function exportWorkOrders() {
            try {
                const response = await fetch('/api/work-orders');
                const workOrders = await response.json();
                
                if (workOrders.length === 0) {
                    alert('No work orders to export');
                    return;
                }
                
                const dataStr = JSON.stringify(workOrders, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `work_orders_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error exporting work orders');
            }
        }

        function searchCatalog() {
            const query = document.getElementById('searchBox').value.trim();
            
            if (!query) {
                currentSearchResults = catalogData;
                displayCatalog(groupByAlbum(catalogData));
                return;
            }
            
            const results = catalogData.filter(track => 
                track.album.toLowerCase().includes(query.toLowerCase()) ||
                track.artist.toLowerCase().includes(query.toLowerCase()) ||
                track.track.toLowerCase().includes(query.toLowerCase())
            );
            
            currentSearchResults = results;
            displayCatalog(groupByAlbum(results));
        }

        function clearSearch() {
            document.getElementById('searchBox').value = '';
            currentSearchResults = catalogData;
            displayCatalog(groupByAlbum(catalogData));
        }

        function groupByAlbum(tracks) {
            const albums = {};
            tracks.forEach(track => {
                const albumName = track.album || 'Unknown Album';
                if (!albums[albumName]) {
                    albums[albumName] = {
                        album: albumName,
                        artist: track.artist || 'AeroVista',
                        tracks: [],
                        cover: track.cover_file || '',
                        total_duration: 0,
                        total_size: 0
                    };
                }
                albums[albumName].tracks.push(track);
            });
            return albums;
        }

        function showLyrics(lyricsFile, trackName) {
            // For now, show a placeholder. In a real implementation, you'd fetch the lyrics file
            document.getElementById('modalTitle').textContent = `Lyrics - ${trackName}`;
            document.getElementById('modalContent').innerHTML = `
                <p><strong>Track:</strong> ${trackName}</p>
                <p><strong>Lyrics File:</strong> ${lyricsFile}</p>
                <p style="color: #888; margin-top: 20px;">
                    Lyrics content would be loaded from the file here.
                    In the full implementation, this would parse and display the actual lyrics.
                </p>
            `;
            document.getElementById('lyricsModal').style.display = 'block';
        }

        function closeLyricsModal() {
            document.getElementById('lyricsModal').style.display = 'none';
        }

        // Audio Player Functionality
        let currentTrack = null;
        let currentAlbum = null;
        let currentTrackIndex = 0;
        let isPlaying = false;
        
        // Initialize persistent audio system
        let persistentAudio = null;
        
        // Initialize persistent audio
        function initializePersistentAudio() {
            if (typeof window.initializePersistentAudio === 'function') {
                window.initializePersistentAudio();
                persistentAudio = window.persistentAudio;
                console.log('Persistent audio system initialized');
            } else {
                console.warn('Persistent audio system not available');
            }
        }
        
        const audioElement = document.getElementById('audioElement');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeProgress = document.getElementById('volumeProgress');
        const closePlayer = document.getElementById('closePlayer');
        
        // Initialize audio player
        function initAudioPlayer() {
            // Set initial volume
            audioElement.volume = 0.7;
            updateVolumeDisplay();
            
            // Event listeners
            playPauseBtn.addEventListener('click', togglePlayPause);
            progressBar.addEventListener('click', seekTo);
            volumeSlider.addEventListener('click', setVolume);
            closePlayer.addEventListener('click', hidePlayer);
            
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('loadedmetadata', updateDuration);
            audioElement.addEventListener('ended', playNext);
        }
        
        // Enhanced unified audio playback function
        function playTrack(filePath, trackName = '', albumName = '', artistName = '', tailscaleUrl = null, apiAudioPathparam = null) {
            console.log('🎵 Playing track:', trackName, 'by', artistName);
            
            // Show loading state
            showAudioLoading(trackName);
            
            // Update player display
            document.getElementById('playerTitle').textContent = trackName || 'Unknown Track';
            document.getElementById('playerArtist').textContent = `${artistName || 'Unknown Artist'} - ${albumName || 'Unknown Album'}`;
            
            // Update cover
            const playerCover = document.getElementById('playerCover');
            playerCover.innerHTML = '<div class="loading-spinner">🎵</div>';
            
            // Try to load album art
            if (albumName) {
                const coverImg = document.createElement('img');
                coverImg.src = `/api/album-art/${encodeURIComponent(albumName)}`;
                coverImg.onload = () => {
                    playerCover.innerHTML = '';
                    playerCover.appendChild(coverImg);
                };
                coverImg.onerror = () => {
                    console.log('Album art not found for:', albumName);
                    playerCover.innerHTML = '<div>🎵</div>';
                };
            }
            
            // Use persistent audio system if available
            if (persistentAudio && typeof persistentAudio.playTrack === 'function') {
                const trackData = {
                    src: getBestAudioUrl(filePath, tailscaleUrl, apiAudioPathparam),
                    track: trackName,
                    artist: artistName,
                    album: albumName
                };
                persistentAudio.playTrack(trackData);
                return;
            }
            
            // Fallback to local audio element
            const audioUrl = getBestAudioUrl(filePath, tailscaleUrl, apiAudioPathparam);
            console.log('🔗 Using audio URL:', audioUrl);
            
            // Set audio source
            audioElement.src = audioUrl;
            audioElement.load();
            
            // Show player and try to play
            showPlayer();
            
            const playPromise = audioElement.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    isPlaying = true;
                    playPauseBtn.textContent = '⏸️';
                    console.log('✅ Audio playback started successfully');
                    hideAudioError();
                    hideAudioLoading();
                }).catch(error => {
                    console.error('❌ Error playing audio:', error);
                    handleAudioPlaybackError(error, trackName, filePath, tailscaleUrl, apiAudioPathparam);
                });
            }
        }
        
        // Get the best audio URL with improved logic
        function getBestAudioUrl(filePath, tailscaleUrl, apiAudioPathparam) {
            const useTailscale = document.getElementById('tailscaleEnabled')?.checked ?? true;
            
            // Priority order: Tailscale URL > API path > Enhanced API > Direct API
            if (tailscaleUrl && tailscaleUrl.trim() !== '') {
                console.log('🎯 Using Tailscale URL from CSV');
                return tailscaleUrl;
            } else if (apiAudioPathparam && apiAudioPathparam.trim() !== '') {
                console.log('🎯 Using API path from CSV');
                return apiAudioPathparam;
            } else if (useTailscale) {
                console.log('🎯 Using enhanced API with Tailscale');
                const encodedPath = encodeURIComponent(filePath);
                return `/api/audio/${encodedPath}?use_tailscale=true`;
            } else {
                console.log('🎯 Using direct API');
                const encodedPath = encodeURIComponent(filePath);
                return `/api/audio/${encodedPath}?use_tailscale=false`;
            }
        }
        
        // Enhanced error handling for audio playback
        function handleAudioPlaybackError(error, trackName, filePath, tailscaleUrl, apiAudioPathparam) {
            console.log('🔄 Attempting fallback methods...');
            
            const fallbackMethods = [];
            const useTailscale = document.getElementById('tailscaleEnabled')?.checked ?? true;
            
            // Build fallback chain
            if (tailscaleUrl && audioElement.src !== tailscaleUrl) {
                fallbackMethods.push({ url: tailscaleUrl, name: 'Tailscale URL' });
            }
            if (apiAudioPathparam && audioElement.src !== apiAudioPathparam) {
                fallbackMethods.push({ url: apiAudioPathparam, name: 'API Path' });
            }
            if (useTailscale) {
                const encodedPath = encodeURIComponent(filePath);
                const enhancedUrl = `/api/audio/${encodedPath}?use_tailscale=true`;
                if (audioElement.src !== enhancedUrl) {
                    fallbackMethods.push({ url: enhancedUrl, name: 'Enhanced API' });
                }
            }
            const encodedPath = encodeURIComponent(filePath);
            const directUrl = `/api/audio/${encodedPath}?use_tailscale=false`;
            if (audioElement.src !== directUrl) {
                fallbackMethods.push({ url: directUrl, name: 'Direct API' });
            }
            
            if (fallbackMethods.length > 0) {
                tryFallbackMethod(fallbackMethods, 0, trackName);
            } else {
                showAudioError(`Cannot play ${trackName || 'track'}. All methods failed.`);
            }
        }
        
        // Try fallback methods recursively
        function tryFallbackMethod(fallbackMethods, index, trackName) {
            if (index >= fallbackMethods.length) {
                showAudioError(`Cannot play ${trackName || 'track'}. All methods failed.`);
                return;
            }
            
            const method = fallbackMethods[index];
            console.log(`🔄 Trying ${method.name} fallback:`, method.url);
            
            audioElement.src = method.url;
            audioElement.load();
            
            const playPromise = audioElement.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    isPlaying = true;
                    playPauseBtn.textContent = '⏸️';
                    console.log(`✅ ${method.name} fallback successful`);
                    hideAudioError();
                    hideAudioLoading();
                }).catch(error => {
                    console.error(`❌ ${method.name} fallback failed:`, error);
                    tryFallbackMethod(fallbackMethods, index + 1, trackName);
                });
            }
        }
        
        // Show audio error message
        function showAudioError(message) {
            const playerTitle = document.getElementById('playerTitle');
            if (playerTitle) {
                playerTitle.textContent = `❌ ${message}`;
                playerTitle.style.color = '#ff6b6b';
            }
        }
        
        // Hide audio error message
        function hideAudioError() {
            const playerTitle = document.getElementById('playerTitle');
            if (playerTitle) {
                playerTitle.style.color = '';
            }
        }
        
        // Show audio loading state
        function showAudioLoading(trackName) {
            const playerTitle = document.getElementById('playerTitle');
            if (playerTitle) {
                playerTitle.textContent = `⏳ Loading ${trackName || 'track'}...`;
                playerTitle.style.color = '#8a5fff';
            }
        }
        
        // Hide audio loading state
        function hideAudioLoading() {
            const playerTitle = document.getElementById('playerTitle');
            if (playerTitle) {
                playerTitle.style.color = '';
            }
        }
        
        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 3000) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                z-index: 10002;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }
        
        // Add CSS for notification animations
        const notificationCSS = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        
        // Inject notification CSS
        const style = document.createElement('style');
        style.textContent = notificationCSS;
        document.head.appendChild(style);
        
        // Toggle play/pause
        function togglePlayPause() {
            if (isPlaying) {
                audioElement.pause();
                isPlaying = false;
                playPauseBtn.textContent = '▶️';
            } else {
                audioElement.play().then(() => {
                    isPlaying = true;
                    playPauseBtn.textContent = '⏸️';
                }).catch(error => {
                    // Could not play audio
                });
            }
        }
        
        // Play next track
        function playNext() {
            // Auto-play next track in album if available
            if (currentAlbum && currentTrackIndex < currentAlbum.tracks.length - 1) {
                const nextTrack = currentAlbum.tracks[currentTrackIndex + 1];
                playTrack(nextTrack.file_path, nextTrack.track, nextTrack.album, nextTrack.artist);
                currentTrackIndex++;
            }
        }
        
        // Update progress bar
        function updateProgress() {
            if (audioElement.duration) {
                const progressPercent = (audioElement.currentTime / audioElement.duration) * 100;
                progress.style.width = progressPercent + '%';
                currentTimeEl.textContent = formatTime(audioElement.currentTime);
            }
        }
        
        // Update duration display
        function updateDuration() {
            durationEl.textContent = formatTime(audioElement.duration);
        }
        
        // Seek to position
        function seekTo(e) {
            if (audioElement.duration) {
                const rect = progressBar.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const width = rect.width;
                const clickPercent = clickX / width;
                audioElement.currentTime = clickPercent * audioElement.duration;
            }
        }
        
        // Set volume
        function setVolume(e) {
            const rect = volumeSlider.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const volume = Math.max(0, Math.min(1, clickX / width));
            
            audioElement.volume = volume;
            updateVolumeDisplay();
        }
        
        // Update volume display
        function updateVolumeDisplay() {
            const volumePercent = audioElement.volume * 100;
            volumeProgress.style.width = volumePercent + '%';
        }
        
        // Format time
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Show player
        function showPlayer() {
            audioPlayer.classList.add('active');
        }
        
        // Hide player
        function hidePlayer() {
            audioPlayer.classList.remove('active');
            audioElement.pause();
            isPlaying = false;
            playPauseBtn.textContent = '▶️';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('lyricsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // Advanced Filtering & Sorting Functions
        function populateFilterOptions() {
            // Populate genre filter with unique genres from catalog
            const genres = [...new Set(catalogData.map(track => track.genre).filter(g => g))];
            const genreFilter = document.getElementById('genreFilter');
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            });
        }
        
        function applyFilters() {
            let filteredData = [...catalogData];
            
            // Apply search filter
            const searchQuery = document.getElementById('searchBox').value.trim().toLowerCase();
            if (searchQuery) {
                filteredData = filteredData.filter(track => 
                    track.album.toLowerCase().includes(searchQuery) ||
                    track.artist.toLowerCase().includes(searchQuery) ||
                    track.track.toLowerCase().includes(searchQuery)
                );
            }
            
            // Apply genre filter
            const genreFilter = document.getElementById('genreFilter').value;
            if (genreFilter) {
                filteredData = filteredData.filter(track => track.genre === genreFilter);
            }
            
            // Apply year range filter
            const yearFrom = document.getElementById('yearFrom').value;
            const yearTo = document.getElementById('yearTo').value;
            if (yearFrom || yearTo) {
                filteredData = filteredData.filter(track => {
                    const year = parseInt(track.year);
                    if (isNaN(year)) return false;
                    if (yearFrom && year < parseInt(yearFrom)) return false;
                    if (yearTo && year > parseInt(yearTo)) return false;
                    return true;
                });
            }
            
            // Apply duration filter
            const durationFilter = document.getElementById('durationFilter').value;
            if (durationFilter) {
                filteredData = filteredData.filter(track => {
                    const duration = track.duration;
                    if (!duration || !duration.includes(':')) return false;
                    const [minutes, seconds] = duration.split(':').map(Number);
                    const totalSeconds = minutes * 60 + seconds;
                    
                    switch(durationFilter) {
                        case 'short': return totalSeconds < 180; // < 3 min
                        case 'medium': return totalSeconds >= 180 && totalSeconds <= 300; // 3-5 min
                        case 'long': return totalSeconds > 300; // > 5 min
                        default: return true;
                    }
                });
            }
            
            // Sort the filtered data
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            filteredData.sort((a, b) => {
                let aVal, bVal;
                
                switch(sortBy) {
                    case 'album':
                        aVal = a.album.toLowerCase();
                        bVal = b.album.toLowerCase();
                        break;
                    case 'artist':
                        aVal = a.artist.toLowerCase();
                        bVal = b.artist.toLowerCase();
                        break;
                    case 'year':
                        aVal = parseInt(a.year) || 0;
                        bVal = parseInt(b.year) || 0;
                        break;
                    case 'genre':
                        aVal = a.genre.toLowerCase();
                        bVal = b.genre.toLowerCase();
                        break;
                    case 'duration':
                        aVal = parseDuration(a.duration);
                        bVal = parseDuration(b.duration);
                        break;
                    case 'size':
                        aVal = a.file_size || 0;
                        bVal = b.file_size || 0;
                        break;
                    case 'track_count':
                        // This will be handled in groupByAlbum
                        aVal = 0;
                        bVal = 0;
                        break;
                    default:
                        aVal = a.album.toLowerCase();
                        bVal = b.album.toLowerCase();
                }
                
                if (sortOrder === 'desc') {
                    [aVal, bVal] = [bVal, aVal];
                }
                
                if (aVal < bVal) return -1;
                if (aVal > bVal) return 1;
                return 0;
            });
            
            // Group the filtered data
            const groupBy = document.getElementById('groupBy').value;
            let groupedData;
            
            if (groupBy === 'none') {
                groupedData = groupByAlbum(filteredData);
            } else {
                groupedData = groupByCustom(filteredData, groupBy);
            }
            
            // Update display
            currentSearchResults = filteredData;
            displayCatalog(groupedData);
            updateFilterStats(filteredData);
        }
        
        function groupByCustom(data, groupType) {
            const groups = {};
            
            data.forEach(track => {
                let groupKey;
                
                switch(groupType) {
                    case 'artist':
                        groupKey = track.artist || 'Unknown Artist';
                        break;
                    case 'year':
                        groupKey = track.year || 'Unknown Year';
                        break;
                    case 'genre':
                        groupKey = track.genre || 'Unknown Genre';
                        break;
                    case 'decade':
                        const year = parseInt(track.year);
                        if (isNaN(year)) {
                            groupKey = 'Unknown Decade';
                        } else {
                            const decade = Math.floor(year / 10) * 10;
                            groupKey = `${decade}s`;
                        }
                        break;
                    default:
                        groupKey = 'Unknown';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        album: groupKey,
                        artist: groupType === 'artist' ? groupKey : 'Various',
                        tracks: [],
                        cover: '',
                        total_duration: 0,
                        total_size: 0,
                        is_group: true
                    };
                }
                
                groups[groupKey].tracks.push(track);
                groups[groupKey].total_size += track.file_size || 0;
                groups[groupKey].total_duration += parseDuration(track.duration);
            });
            
            return groups;
        }
        
        function parseDuration(duration) {
            if (!duration || !duration.includes(':')) return 0;
            const [minutes, seconds] = duration.split(':').map(Number);
            return minutes * 60 + seconds;
        }
        
        function quickFilter(type) {
            let filteredData = [...catalogData];
            
            switch(type) {
                case 'recent':
                    // Sort by file modification time (if available) or just show recent additions
                    filteredData.sort((a, b) => (b.file_path || '').localeCompare(a.file_path || ''));
                    break;
                case 'favorites':
                    // Filter tracks marked as favorites (you can implement this later)
                    filteredData = filteredData.filter(track => track.favorite);
                    break;
                case 'unplayed':
                    // Filter tracks that haven't been played (you can implement this later)
                    filteredData = filteredData.filter(track => !track.last_played);
                    break;
                case 'longest':
                    filteredData.sort((a, b) => parseDuration(b.duration) - parseDuration(a.duration));
                    break;
            }
            
            currentSearchResults = filteredData;
            displayCatalog(groupByAlbum(filteredData));
            updateFilterStats(filteredData);
        }
        
        function setViewMode(mode) {
            // Update active button
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Apply view mode styles
            const musicGrid = document.getElementById('musicGrid');
            musicGrid.className = `music-grid view-${mode}`;
            
            // You can add more view mode logic here
        }
        
        function updateFilterStats(data) {
            // Update the stats display to show filtered results
            const totalAlbums = document.getElementById('totalAlbums');
            const totalTracks = document.getElementById('totalTracks');
            
            if (data.length !== catalogData.length) {
                totalAlbums.textContent = Object.keys(groupByAlbum(data)).length;
                totalTracks.textContent = data.length;
                totalAlbums.style.color = '#667eea';
                totalTracks.style.color = '#667eea';
            } else {
                totalAlbums.textContent = Object.keys(albums_data).length;
                totalTracks.textContent = catalogData.length;
                totalAlbums.style.color = '';
                totalTracks.style.color = '';
            }
        }
        
        // Lazy Loading Implementation
        function initializeLazyLoading() {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy-image');
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px', // Start loading 50px before image comes into view
                threshold: 0.1
            });
            
            // Observe all lazy images
            document.querySelectorAll('.lazy-image').forEach(img => {
                imageObserver.observe(img);
            });
        }
        
        // Trace track relationships
        async function traceTrack(trackId) {
            try {
                const response = await fetch(`/api/track/${trackId}`);
                const data = await response.json();
                
                const traceInfo = `
                    <h3>🔗 Track Relationship Trace</h3>
                    <p><strong>Track:</strong> ${data.track.track}</p>
                    <p><strong>Track ID:</strong> ${data.track.id}</p>
                    <p><strong>Album:</strong> ${data.track.album} (ID: ${data.track.album_id})</p>
                    <p><strong>Artist:</strong> ${data.track.artist} (ID: ${data.track.artist_id})</p>
                    <p><strong>Trace Path:</strong> ${data.relationships.trace_path}</p>
                    <p><strong>File:</strong> ${data.track.file_path}</p>
                    <p><strong>Cover:</strong> ${data.track.cover_file || 'None'}</p>
                    <p><strong>Lyrics:</strong> ${data.track.lyrics_file || 'None'}</p>
                `;
                
                document.getElementById('modalTitle').textContent = `Track Trace - ${data.track.track}`;
                document.getElementById('modalContent').innerHTML = traceInfo;
                document.getElementById('lyricsModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error tracing track:', error);
                alert('Error tracing track relationships');
            }
        }
        
        // Re-initialize lazy loading when catalog is updated
        function refreshLazyLoading() {
            setTimeout(() => {
                initializeLazyLoading();
            }, 100);
        }
        
        // Sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sidebar
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarClose = document.getElementById('sidebarClose');
            const mainContent = document.getElementById('mainContent');
            const sidebarTabs = document.querySelectorAll('.sidebar-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Toggle sidebar
            sidebarToggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const isCurrentlyOpen = sidebar.classList.contains('active');
                
                if (isCurrentlyOpen) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-active');
                } else {
                    sidebar.classList.add('active');
                    mainContent.classList.add('sidebar-active');
                }
                
                // Save sidebar state
                const isOpen = sidebar.classList.contains('active');
                localStorage.setItem('echoverse_sidebar_open', isOpen);
            });
            
            // Prevent event bubbling on sidebar toggle
            sidebarToggle.addEventListener('mousedown', function(e) {
                e.preventDefault();
            });
            
            // Close sidebar
            if (sidebarClose) {
                sidebarClose.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-active');
                });
            }
            
            // Tab switching
            sidebarTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    sidebarTabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Save last active tab to localStorage
                    localStorage.setItem('echoverse_active_tab', tabId);
                });
            });
            
            // Restore last active tab from localStorage
            const lastActiveTab = localStorage.getItem('echoverse_active_tab');
            if (lastActiveTab) {
                const tabToActivate = document.querySelector(`.sidebar-tab[data-tab="${lastActiveTab}"]`);
                if (tabToActivate) {
                    tabToActivate.click();
                }
            }
            
            // Close sidebar when clicking outside
            document.addEventListener('click', function(event) {
                if (sidebar.classList.contains('active') && 
                    !sidebar.contains(event.target) && 
                    event.target !== sidebarToggle) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-active');
                }
            });
            
            // Keyboard shortcut for sidebar toggle
            document.addEventListener('keydown', function(event) {
                if (event.key === 's' || event.key === 'S') {
                    sidebarToggle.click();
                }
            });
            
            // Sync sidebar search with main search
            const mainSearchBox = document.getElementById('searchBox');
            const sidebarSearchBox = document.getElementById('sidebarSearchBox');
            
            if (mainSearchBox && sidebarSearchBox) {
                // Keep the search boxes in sync
                mainSearchBox.addEventListener('input', function() {
                    sidebarSearchBox.value = this.value;
                });
                
                sidebarSearchBox.addEventListener('input', function() {
                    mainSearchBox.value = this.value;
                    
                    // Debounce search
                    clearTimeout(window.searchTimeout);
                    window.searchTimeout = setTimeout(() => {
                        performSearch(this.value);
                    }, 300);
                });
            }
            
            // Initialize Path Tool functionality
            const convertPathBtn = document.getElementById('convertPathBtn');
            if (convertPathBtn) {
                convertPathBtn.addEventListener('click', convertPath);
            }
            
            // Initialize Tailscale settings
            loadTailscaleConfig();
            const saveConfigBtn = document.getElementById('saveConfigBtn');
            if (saveConfigBtn) {
                saveConfigBtn.addEventListener('click', saveTailscaleConfig);
            }
            
            // Initialize interface settings
            const saveInterfaceSettings = document.getElementById('saveInterfaceSettings');
            if (saveInterfaceSettings) {
                saveInterfaceSettings.addEventListener('click', saveInterface);
            }
            
            // Theme customizer button
            const openThemeCustomizerBtn = document.getElementById('openThemeCustomizer');
            if (openThemeCustomizerBtn) {
                openThemeCustomizerBtn.addEventListener('click', openThemeCustomizer);
            }
            
            // Wire up settings functionality
            wireUpSettings();
            
            // Initialize player settings
            const savePlayerSettings = document.getElementById('savePlayerSettings');
            if (savePlayerSettings) {
                savePlayerSettings.addEventListener('click', savePlayer);
            }
            
            // Update volume display when slider changes
            const volumeRange = document.getElementById('defaultVolumeRange');
            if (volumeRange) {
                volumeRange.addEventListener('input', function() {
                    document.getElementById('volumeValue').textContent = this.value + '%';
                });
            }
            
            // Sync sidebar filter controls with main filters
            const sidebarSortBy = document.getElementById('sidebarSortBy');
            const sidebarSortOrder = document.getElementById('sidebarSortOrder');
            const sidebarGroupBy = document.getElementById('sidebarGroupBy');
            const sidebarGenreFilter = document.getElementById('sidebarGenreFilter');
            const sidebarYearFrom = document.getElementById('sidebarYearFrom');
            const sidebarYearTo = document.getElementById('sidebarYearTo');
            const sidebarDurationFilter = document.getElementById('sidebarDurationFilter');
            
            const mainSortBy = document.getElementById('sortBy');
            const mainSortOrder = document.getElementById('sortOrder');
            const mainGroupBy = document.getElementById('groupBy');
            const mainGenreFilter = document.getElementById('genreFilter');
            const mainYearFrom = document.getElementById('yearFrom');
            const mainYearTo = document.getElementById('yearTo');
            const mainDurationFilter = document.getElementById('durationFilter');
            
            // Sync filter values on load
            if (sidebarSortBy && mainSortBy) sidebarSortBy.value = mainSortBy.value;
            if (sidebarSortOrder && mainSortOrder) sidebarSortOrder.value = mainSortOrder.value;
            if (sidebarGroupBy && mainGroupBy) sidebarGroupBy.value = mainGroupBy.value;
            if (sidebarGenreFilter && mainGenreFilter) sidebarGenreFilter.value = mainGenreFilter.value;
            if (sidebarYearFrom && mainYearFrom) sidebarYearFrom.value = mainYearFrom.value;
            if (sidebarYearTo && mainYearTo) sidebarYearTo.value = mainYearTo.value;
            if (sidebarDurationFilter && mainDurationFilter) sidebarDurationFilter.value = mainDurationFilter.value;
            
            // Add reset filters function
            window.resetFilters = function() {
                if (sidebarSortBy) sidebarSortBy.value = 'album';
                if (sidebarSortOrder) sidebarSortOrder.value = 'asc';
                if (sidebarGroupBy) sidebarGroupBy.value = 'none';
                if (sidebarGenreFilter) sidebarGenreFilter.value = '';
                if (sidebarYearFrom) sidebarYearFrom.value = '';
                if (sidebarYearTo) sidebarYearTo.value = '';
                if (sidebarDurationFilter) sidebarDurationFilter.value = '';
                
                // Sync with main controls
                if (mainSortBy) mainSortBy.value = 'album';
                if (mainSortOrder) mainSortOrder.value = 'asc';
                if (mainGroupBy) mainGroupBy.value = 'none';
                if (mainGenreFilter) mainGenreFilter.value = '';
                if (mainYearFrom) mainYearFrom.value = '';
                if (mainYearTo) mainYearTo.value = '';
                if (mainDurationFilter) mainDurationFilter.value = '';
                
                // Apply filters
                applyFilters();
            };
            
            // Make sidebar responsive
            window.addEventListener('resize', function() {
                if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
                    mainContent.classList.remove('sidebar-active');
                } else if (window.innerWidth > 768 && sidebar.classList.contains('active')) {
                    mainContent.classList.add('sidebar-active');
                }
            });
        });
        
        // Path conversion function
        async function convertPath() {
            const inputPath = document.getElementById('inputPath').value.trim();
            const resultContainer = document.getElementById('conversionResult');
            
            if (!inputPath) {
                resultContainer.innerHTML = '<p style="color: #ff6b6b;">Please enter a file path.</p>';
                return;
            }
            
            try {
                resultContainer.innerHTML = '<p>Converting path...</p>';
                
                const response = await fetch(`/api/convert-path?path=${encodeURIComponent(inputPath)}`);
                const data = await response.json();
                
                if (data.tailscale_url) {
                    resultContainer.innerHTML = `
                        <p style="margin-bottom: 8px;"><strong>Original Path:</strong></p>
                        <p style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; margin-bottom: 16px;">${data.original_path}</p>
                        
                        <p style="margin-bottom: 8px;"><strong>Tailscale URL:</strong></p>
                        <p style="background: rgba(102,126,234,0.2); padding: 8px; border-radius: 4px; color: #667eea;">${data.tailscale_url}</p>
                        
                        <button id="copyUrlBtn" class="btn" style="margin-top: 12px;">Copy URL</button>
                        <button id="testUrlBtn" class="btn" style="margin-top: 12px; margin-left: 8px;">Test URL</button>
                    `;
                    
                    // Add event listeners for the copy and test buttons
                    document.getElementById('copyUrlBtn').addEventListener('click', () => {
                        navigator.clipboard.writeText(data.tailscale_url)
                            .then(() => alert('URL copied to clipboard!'))
                            .catch(err => console.error('Could not copy text: ', err));
                    });
                    
                    document.getElementById('testUrlBtn').addEventListener('click', () => {
                        window.open(data.tailscale_url, '_blank');
                    });
                } else {
                    resultContainer.innerHTML = `
                        <p style="color: #ff6b6b;"><strong>Error:</strong> ${data.error}</p>
                        <p><strong>Original Path:</strong> ${data.original_path}</p>
                        <p>Make sure the path contains "Albums" and follows one of the example formats.</p>
                    `;
                }
            } catch (error) {
                console.error('Error converting path:', error);
                resultContainer.innerHTML = `<p style="color: #ff6b6b;"><strong>Error:</strong> Failed to convert path. Check console for details.</p>`;
            }
        }
        
        // Wire up settings functionality
        function wireUpSettings() {
            // Theme settings
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                // Load saved theme
                const savedTheme = localStorage.getItem('echoverse_theme') || 'dark';
                themeSelect.value = savedTheme;
                applyTheme(savedTheme);
                
                themeSelect.addEventListener('change', function() {
                    const theme = this.value;
                    localStorage.setItem('echoverse_theme', theme);
                    applyTheme(theme);
                });
            }
            
            // Font size settings
            const fontSizeSelect = document.getElementById('fontSizeSelect');
            if (fontSizeSelect) {
                // Load saved font size
                const savedFontSize = localStorage.getItem('echoverse_font_size') || 'medium';
                fontSizeSelect.value = savedFontSize;
                applyFontSize(savedFontSize);
                
                fontSizeSelect.addEventListener('change', function() {
                    const fontSize = this.value;
                    localStorage.setItem('echoverse_font_size', fontSize);
                    applyFontSize(fontSize);
                });
            }
            
            // Volume settings
            const volumeRange = document.getElementById('volumeRange');
            if (volumeRange) {
                // Load saved volume
                const savedVolume = localStorage.getItem('echoverse_volume') || '70';
                volumeRange.value = savedVolume;
                updateVolumeDisplay(savedVolume);
                
                volumeRange.addEventListener('input', function() {
                    const volume = this.value;
                    localStorage.setItem('echoverse_volume', volume);
                    updateVolumeDisplay(volume);
                    
                    // Apply to audio player if it exists
                    const audioPlayer = document.getElementById('audioPlayer');
                    if (audioPlayer) {
                        audioPlayer.volume = volume / 100;
                    }
                });
            }
        }
        
        // Apply theme
        function applyTheme(theme) {
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            document.body.classList.add(`theme-${theme}`);
            
            // Update CSS variables based on theme
            const root = document.documentElement;
            if (theme === 'light') {
                root.style.setProperty('--dark-bg', '#f8f9fa');
                root.style.setProperty('--dark-card-bg', '#ffffff');
                root.style.setProperty('--text-primary', '#212529');
                root.style.setProperty('--text-secondary', '#6c757d');
            } else if (theme === 'contrast') {
                root.style.setProperty('--dark-bg', '#000000');
                root.style.setProperty('--dark-card-bg', '#1a1a1a');
                root.style.setProperty('--text-primary', '#ffffff');
                root.style.setProperty('--text-secondary', '#cccccc');
            } else {
                // Dark theme (default)
                root.style.setProperty('--dark-bg', '#0f0f23');
                root.style.setProperty('--dark-card-bg', '#1a1a2e');
                root.style.setProperty('--text-primary', '#ffffff');
                root.style.setProperty('--text-secondary', '#b0b0b0');
            }
        }
        
        // Apply font size
        function applyFontSize(fontSize) {
            const root = document.documentElement;
            const sizes = {
                'small': '12px',
                'medium': '14px',
                'large': '16px',
                'xlarge': '18px'
            };
            root.style.setProperty('--base-font-size', sizes[fontSize] || sizes.medium);
        }
        
        // Update volume display
        function updateVolumeDisplay(volume) {
            const volumeDisplay = document.getElementById('volumeDisplay');
            if (volumeDisplay) {
                volumeDisplay.textContent = `${volume}%`;
            }
        }
        
        // Function to load Tailscale configuration
        async function loadTailscaleConfig() {
            try {
                const response = await fetch('/api/config/tailscale');
                const config = await response.json();
                
                const domainInput = document.getElementById('tailscaleDomain');
                const musicPathInput = document.getElementById('tailscaleMusicPath');
                const enabledCheckbox = document.getElementById('tailscaleEnabled');
                const fallbackCheckbox = document.getElementById('tailscaleFallback');
                const configStatus = document.getElementById('configStatus');
                
                if (domainInput) domainInput.value = config.tailscale.domain;
                if (musicPathInput) musicPathInput.value = config.tailscale.music_path;
                if (enabledCheckbox) enabledCheckbox.checked = config.tailscale.enabled;
                if (fallbackCheckbox) fallbackCheckbox.checked = config.tailscale.fallback_to_direct;
                
                if (configStatus) configStatus.innerHTML = '<p style="color: #4ade80;">Configuration loaded successfully.</p>';
            } catch (error) {
                console.error('Error loading Tailscale config:', error);
                const configStatus = document.getElementById('configStatus');
                if (configStatus) configStatus.innerHTML = '<p style="color: #ff6b6b;">Error loading configuration. Check console for details.</p>';
            }
        }
        
        // Function to save Tailscale configuration
        async function saveTailscaleConfig() {
            try {
                const domain = document.getElementById('tailscaleDomain').value.trim();
                const musicPath = document.getElementById('tailscaleMusicPath').value.trim() || '';
                const enabled = document.getElementById('tailscaleEnabled').checked;
                const fallback = document.getElementById('tailscaleFallback').checked;
                const configStatus = document.getElementById('configStatus');
                
                if (!domain) {
                    configStatus.innerHTML = '<p style="color: #ff6b6b;">Tailscale URL is required.</p>';
                    return;
                }
                
                // Get current config first to preserve other settings
                const getResponse = await fetch('/api/config/tailscale');
                const currentConfig = await getResponse.json();
                
                // Update only the tailscale section
                const updatedConfig = {
                    ...currentConfig,
                    tailscale: {
                        domain: domain,
                        music_path: musicPath,
                        enabled: enabled,
                        fallback_to_direct: fallback
                    }
                };
                
                // Save the updated configuration
                const response = await fetch('/api/config/tailscale', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedConfig)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    configStatus.innerHTML = '<p style="color: #4ade80;">Configuration saved successfully.</p>';
                } else {
                    configStatus.innerHTML = `<p style="color: #ff6b6b;">Error: ${result.message}</p>`;
                }
            } catch (error) {
                console.error('Error saving Tailscale config:', error);
                document.getElementById('configStatus').innerHTML = '<p style="color: #ff6b6b;">Error saving configuration. Check console for details.</p>';
            }
        }
        
        // Function to save interface settings
        function saveInterface() {
            const theme = document.getElementById('themeSelect').value;
            const fontSize = document.getElementById('fontSizeSelect').value;
            const animations = document.getElementById('animationsEnabled').checked;
            
            // Save to localStorage
            localStorage.setItem('echoverse_theme', theme);
            localStorage.setItem('echoverse_fontSize', fontSize);
            localStorage.setItem('echoverse_animations', animations);
            
            // Apply settings
            applyInterfaceSettings(theme, fontSize, animations);
            
            // Show confirmation
            alert('Interface settings saved successfully!');
        }
        
        // Function to apply interface settings
        function applyInterfaceSettings(theme, fontSize, animations) {
            // Apply theme
            document.body.className = ''; // Clear existing classes
            document.body.classList.add(`theme-${theme}`);
            
            // Apply font size
            document.body.style.fontSize = getFontSizeValue(fontSize);
            
            // Apply animations
            if (!animations) {
                document.body.classList.add('no-animations');
            }
        }
        
        // Helper function to get font size value
        function getFontSizeValue(size) {
            switch(size) {
                case 'small': return '14px';
                case 'medium': return '16px';
                case 'large': return '18px';
                case 'x-large': return '20px';
                default: return '16px';
            }
        }
        
        // Function to save player settings
        function savePlayer() {
            const volume = document.getElementById('defaultVolumeRange').value;
            const autoplay = document.getElementById('autoplayEnabled').checked;
            const continuous = document.getElementById('continuousPlayback').checked;
            
            // Save to localStorage
            localStorage.setItem('echoverse_volume', volume);
            localStorage.setItem('echoverse_autoplay', autoplay);
            localStorage.setItem('echoverse_continuous', continuous);
            
            // Apply settings to current player
            if (audioElement) {
                audioElement.volume = volume / 100;
                updateVolumeDisplay();
            }
            
            // Show confirmation
            alert('Player settings saved successfully!');
        }

        // ========================================
        // LUXURY FEATURES INTEGRATION
        // ========================================
        
        // Enhanced Audio Processing Variables
        let audioContext, analyser, gainNode, bassFilter, trebleFilter, reverbNode, source, spectrumBars, animationId;
        
        // Initialize Enhanced Audio Processing
        function initializeAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                gainNode = audioContext.createGain();
                
                // Create EQ filters
                bassFilter = audioContext.createBiquadFilter();
                bassFilter.type = 'lowshelf';
                bassFilter.frequency.setValueAtTime(250, audioContext.currentTime);
                
                trebleFilter = audioContext.createBiquadFilter();
                trebleFilter.type = 'highshelf';
                trebleFilter.frequency.setValueAtTime(4000, audioContext.currentTime);
                
                // Create reverb
                reverbNode = audioContext.createConvolver();
                createReverbImpulse();
                
                // Connect audio graph
                source = audioContext.createMediaElementSource(audioElement);
                source.connect(bassFilter);
                bassFilter.connect(trebleFilter);
                trebleFilter.connect(gainNode);
                gainNode.connect(reverbNode);
                reverbNode.connect(analyser);
                analyser.connect(audioContext.destination);
                
                // Configure analyser
                analyser.fftSize = 64;
                analyser.smoothingTimeConstant = 0.8;
                
                // Create spectrum bars
                createSpectrumBars();
            }
        }
        
        // Create reverb impulse response
        function createReverbImpulse() {
            const length = audioContext.sampleRate * 2;
            const impulse = audioContext.createBuffer(2, length, audioContext.sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
                }
            }
            
            reverbNode.buffer = impulse;
        }
        
        // Create spectrum analyzer bars
        function createSpectrumBars() {
            const spectrumContainer = document.getElementById('spectrumAnalyzer');
            if (!spectrumContainer) return;
            
            spectrumBars = [];
            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.className = 'spectrum-bar';
                bar.style.height = '0px';
                spectrumContainer.appendChild(bar);
                spectrumBars.push(bar);
            }
        }
        
        // Start spectrum analyzer
        function startSpectrumAnalyzer() {
            if (!analyser || !spectrumBars) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function animate() {
                animationId = requestAnimationFrame(animate);
                analyser.getByteFrequencyData(dataArray);
                
                for (let i = 0; i < spectrumBars.length; i++) {
                    const value = dataArray[i] / 255;
                    const height = value * 100;
                    spectrumBars[i].style.height = height + 'px';
                }
            }
            
            animate();
        }
        
        // Stop spectrum analyzer
        function stopSpectrumAnalyzer() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }
        
        // Enhanced audio quality settings
        function setBass(value) {
            if (bassFilter) {
                bassFilter.gain.setValueAtTime(value, audioContext.currentTime);
            }
        }
        
        function setTreble(value) {
            if (trebleFilter) {
                trebleFilter.gain.setValueAtTime(value, audioContext.currentTime);
            }
        }
        
        function setReverb(value) {
            // Initialize audio context if needed
            if (!audioContext) {
                initializeAudioContext();
            }
            
            if (reverbNode) {
                reverbNode.dry.value = 1 - value;
                reverbNode.wet.value = value;
            }
        }
        
        function updateTrackInfo(trackTitle, artistName, albumName) {
            // Update player display with track information
            document.getElementById('playerTitle').textContent = trackTitle || 'Unknown Track';
            document.getElementById('playerArtist').textContent = `${artistName || 'Unknown Artist'} - ${albumName || 'Unknown Album'}`;
        }
        
        // Enhanced playTrack function
        function playTrackDirect(trackUrl, trackTitle, artistName, albumName, trackId) {
            // Initialize audio context if needed
            if (!audioContext) {
                initializeAudioContext();
            }
            
            // Set audio source
            audioElement.src = trackUrl;
            audioElement.load();
            
            // Connect to enhanced audio processor
            if (source) {
                source.disconnect();
                source.connect(bassFilter);
            }
            
            // Start spectrum analyzer
            startSpectrumAnalyzer();
            
            // Enhance audio quality
            setBass(2); // Default bass boost
            setTreble(1); // Default treble boost
            setReverb(0.3); // Default reverb
            
            // Play the track
            audioElement.play().then(() => {
                showPlayer();
                updateTrackInfo(trackTitle, artistName, albumName);
                
                // Increment play count
                if (typeof metadataManager !== 'undefined') {
                    metadataManager.incrementPlayCount(trackId);
                }
            }).catch(error => {
                console.error('Error playing track:', error);
            });
        }
        
        // Context Menu System
        function showTrackContextMenu(event, trackUrl, trackTitle, artistName, albumName, trackId) {
            event.preventDefault();
            
            // Remove existing context menu
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Create context menu
            const contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.style.cssText = `
                position: fixed;
                top: ${event.clientY}px;
                left: ${event.clientX}px;
                background: var(--dark-card-bg);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                padding: 8px 0;
                box-shadow: var(--shadow-heavy);
                z-index: 1000;
                min-width: 200px;
                backdrop-filter: blur(10px);
            `;
            
            // Menu items
            const menuItems = [
                { icon: '🎵', text: 'Play Now', action: () => playTrackDirect(trackUrl, trackTitle, artistName, albumName, trackId) },
                { icon: '➕', text: 'Add to Queue', action: () => addToQueue(trackUrl, trackTitle, artistName, albumName) },
                { icon: '⭐', text: 'Rate Song', action: () => rateSong(trackId, trackTitle) },
                { icon: '📝', text: 'Add Note', action: () => addNote(trackId, trackTitle) },
                { icon: '🏷️', text: 'Add Tags', action: () => addTags(trackId, trackTitle) },
                { icon: '📋', text: 'Work Order', action: () => toggleWorkOrder(trackId, trackTitle) },
                { icon: '📊', text: 'View Details', action: () => viewTrackDetails(trackId, trackTitle, artistName, albumName) },
                { icon: '🔗', text: 'Copy Link', action: () => copyTrackLink(trackUrl, trackTitle) },
                { icon: '📤', text: 'Share Song', action: () => shareSong(trackUrl, trackTitle, artistName, albumName) }
            ];
            
            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                menuItem.style.cssText = `
                    padding: 12px 16px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    transition: all 0.2s ease;
                    color: var(--text-primary);
                `;
                menuItem.innerHTML = `<span style="font-size: 16px;">${item.icon}</span><span>${item.text}</span>`;
                
                menuItem.addEventListener('mouseenter', () => {
                    menuItem.style.background = 'var(--glass-bg)';
                });
                
                menuItem.addEventListener('mouseleave', () => {
                    menuItem.style.background = 'transparent';
                });
                
                menuItem.addEventListener('click', () => {
                    item.action();
                    contextMenu.remove();
                });
                
                contextMenu.appendChild(menuItem);
            });
            
            document.body.appendChild(contextMenu);
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    contextMenu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }
        
        // Context menu action functions
        function addToQueue(trackUrl, trackTitle, artistName, albumName) {
            // Add to persistent queue
            if (typeof persistentAudio !== 'undefined') {
                persistentAudio.addToQueue(trackUrl, trackTitle, artistName, albumName);
            }
            showNotification('Added to queue: ' + trackTitle);
        }
        
        function rateSong(trackId, trackTitle) {
            const rating = prompt(`Rate "${trackTitle}" (1-5 stars):`, '5');
            if (rating && rating >= 1 && rating <= 5) {
                if (typeof metadataManager !== 'undefined') {
                    metadataManager.setRating(trackId, parseInt(rating));
                }
                showNotification(`Rated "${trackTitle}" ${rating} stars`);
            }
        }
        
        function addNote(trackId, trackTitle) {
            const note = prompt(`Add note for "${trackTitle}":`, '');
            if (note) {
                if (typeof metadataManager !== 'undefined') {
                    metadataManager.setNote(trackId, note);
                }
                showNotification(`Note added for "${trackTitle}"`);
            }
        }
        
        function addTags(trackId, trackTitle) {
            const tags = prompt(`Add tags for "${trackTitle}" (comma-separated):`, '');
            if (tags) {
                const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                if (typeof metadataManager !== 'undefined') {
                    metadataManager.setTags(trackId, tagArray);
                }
                showNotification(`Tags added for "${trackTitle}": ${tagArray.join(', ')}`);
            }
        }
        
        function toggleWorkOrder(trackId, trackTitle) {
            if (typeof metadataManager !== 'undefined') {
                const currentStatus = metadataManager.getWorkOrderStatus(trackId);
                const newStatus = !currentStatus;
                metadataManager.setWorkOrderStatus(trackId, newStatus);
                showNotification(`Work order ${newStatus ? 'added' : 'removed'} for "${trackTitle}"`);
            }
        }
        
        function viewTrackDetails(trackId, trackTitle, artistName, albumName) {
            const details = `
Track Details:
Title: ${trackTitle}
Artist: ${artistName}
Album: ${albumName}
ID: ${trackId}
            `;
            alert(details);
        }
        
        function copyTrackLink(trackUrl, trackTitle) {
            navigator.clipboard.writeText(trackUrl).then(() => {
                showNotification(`Link copied for "${trackTitle}"`);
            });
        }
        
        function shareSong(trackUrl, trackTitle, artistName, albumName) {
            const shareText = `Check out "${trackTitle}" by ${artistName} from ${albumName}`;
            if (navigator.share) {
                navigator.share({
                    title: trackTitle,
                    text: shareText,
                    url: trackUrl
                });
            } else {
                navigator.clipboard.writeText(`${shareText}\n${trackUrl}`).then(() => {
                    showNotification(`Share text copied for "${trackTitle}"`);
                });
            }
        }
        
        // Notification system
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--accent-color);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: var(--shadow-medium);
                z-index: 1001;
                font-size: 14px;
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Enhanced theme customization
        function openThemeCustomizer() {
            // Create theme customizer modal
            const modal = document.createElement('div');
            modal.className = 'theme-customizer-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            const customizer = document.createElement('div');
            customizer.style.cssText = `
                background: var(--dark-card-bg);
                border-radius: 16px;
                padding: 24px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            customizer.innerHTML = `
                <h2 style="margin-bottom: 20px; color: var(--text-primary);">🎨 Theme Customizer</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Background Colors:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="color" id="bgColor1" value="#12122c" style="width: 50px; height: 40px; border: none; border-radius: 8px;">
                        <input type="color" id="bgColor2" value="#1a1a35" style="width: 50px; height: 40px; border: none; border-radius: 8px;">
                        <input type="color" id="bgColor3" value="#22223f" style="width: 50px; height: 40px; border: none; border-radius: 8px;">
                    </div>
                    <label style="display: flex; align-items: center; gap: 8px; color: var(--text-primary);">
                        <input type="checkbox" id="bgGradient" checked>
                        <span>Enable Gradient</span>
                    </label>
                    <select id="bgDirection" style="margin-top: 8px; padding: 8px; border-radius: 8px; background: var(--dark-card-bg); color: var(--text-primary); border: 1px solid var(--glass-border);">
                        <option value="0deg">Horizontal</option>
                        <option value="45deg">Diagonal</option>
                        <option value="90deg">Vertical</option>
                        <option value="135deg">Reverse Diagonal</option>
                        <option value="180deg">Reverse Horizontal</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Text Colors:</label>
                    <div style="display: flex; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Primary</label>
                            <input type="color" id="textPrimary" value="#ffffff" style="width: 50px; height: 40px; border: none; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Secondary</label>
                            <input type="color" id="textSecondary" value="#a8a8c0" style="width: 50px; height: 40px; border: none; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Accent</label>
                            <input type="color" id="textAccent" value="#8a5fff" style="width: 50px; height: 40px; border: none; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Button Colors:</label>
                    <div style="display: flex; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Primary</label>
                            <input type="color" id="btnPrimary" value="#8a5fff" style="width: 50px; height: 40px; border: none; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Secondary</label>
                            <input type="color" id="btnSecondary" value="#2d2d50" style="width: 50px; height: 40px; border: none; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="applyCustomTheme()" style="flex: 1; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer;">Apply Theme</button>
                    <button onclick="resetTheme()" style="flex: 1; padding: 12px; background: var(--btn-secondary-bg); color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">Reset</button>
                    <button onclick="closeThemeCustomizer()" style="flex: 1; padding: 12px; background: var(--btn-secondary-bg); color: var(--text-primary); border: none; border-radius: 8px; cursor: pointer;">Close</button>
                </div>
            `;
            
            modal.appendChild(customizer);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeThemeCustomizer();
                }
            });
        }
        
        function applyCustomTheme() {
            const bgColor1 = document.getElementById('bgColor1').value;
            const bgColor2 = document.getElementById('bgColor2').value;
            const bgColor3 = document.getElementById('bgColor3').value;
            const bgGradient = document.getElementById('bgGradient').checked;
            const bgDirection = document.getElementById('bgDirection').value;
            const textPrimary = document.getElementById('textPrimary').value;
            const textSecondary = document.getElementById('textSecondary').value;
            const textAccent = document.getElementById('textAccent').value;
            const btnPrimary = document.getElementById('btnPrimary').value;
            const btnSecondary = document.getElementById('btnSecondary').value;
            
            // Apply CSS variables
            const root = document.documentElement;
            root.style.setProperty('--dark-bg', bgGradient ? `linear-gradient(${bgDirection}, ${bgColor1}, ${bgColor2}, ${bgColor3})` : bgColor1);
            root.style.setProperty('--dark-card-bg', bgColor2);
            root.style.setProperty('--dark-card-hover', bgColor3);
            root.style.setProperty('--text-primary', textPrimary);
            root.style.setProperty('--text-secondary', textSecondary);
            root.style.setProperty('--text-accent', textAccent);
            root.style.setProperty('--accent-color', textAccent);
            root.style.setProperty('--btn-primary-bg', btnPrimary);
            root.style.setProperty('--btn-secondary-bg', btnSecondary);
            
            // Save theme
            const customTheme = {
                bgColor1, bgColor2, bgColor3, bgGradient, bgDirection,
                textPrimary, textSecondary, textAccent, btnPrimary, btnSecondary
            };
            localStorage.setItem('echoverse_custom_theme', JSON.stringify(customTheme));
            
            showNotification('Custom theme applied successfully!');
        }
        
        function resetTheme() {
            // Reset to default theme
            const root = document.documentElement;
            root.style.setProperty('--dark-bg', '#12122c');
            root.style.setProperty('--dark-card-bg', '#1a1a35');
            root.style.setProperty('--dark-card-hover', '#22223f');
            root.style.setProperty('--text-primary', '#ffffff');
            root.style.setProperty('--text-secondary', '#a8a8c0');
            root.style.setProperty('--text-accent', '#8a5fff');
            root.style.setProperty('--accent-color', '#8a5fff');
            root.style.setProperty('--btn-primary-bg', '#8a5fff');
            root.style.setProperty('--btn-secondary-bg', '#2d2d50');
            
            localStorage.removeItem('echoverse_custom_theme');
            showNotification('Theme reset to default');
        }
        
        function closeThemeCustomizer() {
            const modal = document.querySelector('.theme-customizer-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Load custom theme on page load
        function loadCustomTheme() {
            const savedTheme = localStorage.getItem('echoverse_custom_theme');
            if (savedTheme) {
                const theme = JSON.parse(savedTheme);
                const root = document.documentElement;
                root.style.setProperty('--dark-bg', theme.bgGradient ? `linear-gradient(${theme.bgDirection}, ${theme.bgColor1}, ${theme.bgColor2}, ${theme.bgColor3})` : theme.bgColor1);
                root.style.setProperty('--dark-card-bg', theme.bgColor2);
                root.style.setProperty('--dark-card-hover', theme.bgColor3);
                root.style.setProperty('--text-primary', theme.textPrimary);
                root.style.setProperty('--text-secondary', theme.textSecondary);
                root.style.setProperty('--text-accent', theme.textAccent);
                root.style.setProperty('--accent-color', theme.textAccent);
                root.style.setProperty('--btn-primary-bg', theme.btnPrimary);
                root.style.setProperty('--btn-secondary-bg', theme.btnSecondary);
            }
        }
        
        // Initialize luxury features on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomTheme();
            
            // Add context menu to track items
            document.addEventListener('contextmenu', function(e) {
                const trackItem = e.target.closest('.track-item, .album-item');
                if (trackItem) {
                    const trackUrl = trackItem.dataset.trackUrl;
                    const trackTitle = trackItem.dataset.trackTitle;
                    const artistName = trackItem.dataset.artistName;
                    const albumName = trackItem.dataset.albumName;
                    const trackId = trackItem.dataset.trackId;
                    
                    if (trackUrl && trackTitle) {
                        showTrackContextMenu(e, trackUrl, trackTitle, artistName, albumName, trackId);
                    }
                }
            });
        });

        // Enhanced play by direct URL - GLOBAL SCOPE
        window.playTrackByUrl = function(trackUrl, trackTitle, artistName, albumName, trackId) {
            console.log('🎵 Playing track by URL:', trackTitle, 'by', artistName);
            
            // Use persistent audio system if available
            if (persistentAudio && typeof persistentAudio.playTrack === 'function') {
                const trackData = {
                    src: trackUrl,
                    track: trackTitle,
                    artist: artistName,
                    album: albumName
                };
                persistentAudio.playTrack(trackData);
                return;
            }
            
            // Fallback to local audio element
            audioElement.src = trackUrl;
            audioElement.load();
            
            // Update player display
            document.getElementById('playerTitle').textContent = trackTitle || 'Unknown Track';
            document.getElementById('playerArtist').textContent = `${artistName || 'Unknown Artist'} - ${albumName || 'Unknown Album'}`;
            
            // Show player and try to play
            showPlayer();
            
            const playPromise = audioElement.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    isPlaying = true;
                    playPauseBtn.textContent = '⏸️';
                    console.log('✅ Audio playback started successfully');
                    hideAudioError();
                    
                    // Increment play count
                    if (typeof metadataManager !== 'undefined') {
                        metadataManager.incrementPlayCount(trackId);
                    }
                }).catch(error => {
                    console.error('❌ Error playing track:', error);
                    showAudioError(`Cannot play ${trackTitle || 'track'}. Check console for details.`);
                });
            }
        }
        
        // Enhanced Work Order System
        let enhancedWorkOrderTracks = [];
        let currentWorkOrderStatus = 'pending';
        
        // Open enhanced work order popup
        function openWorkOrderPopup() {
            const popup = document.getElementById('workOrderPopup');
            popup.classList.add('active');
            loadWorkOrderData();
            updateWorkOrderStatistics();
        }
        
        // Close enhanced work order popup
        function closeWorkOrderPopup() {
            const popup = document.getElementById('workOrderPopup');
            popup.classList.remove('active');
            saveWorkOrderData();
        }
        
        // Load work order data from localStorage
        function loadWorkOrderData() {
            const savedData = localStorage.getItem('enhancedWorkOrderData');
            if (savedData) {
                const data = JSON.parse(savedData);
                enhancedWorkOrderTracks = data.tracks || [];
                currentWorkOrderStatus = data.status || 'pending';
                
                // Populate form fields
                document.getElementById('popupWorkOrderType').value = data.type || 'playlist';
                document.getElementById('popupWorkOrderTitle').value = data.title || '';
                document.getElementById('popupWorkOrderDescription').value = data.description || '';
                document.getElementById('popupWorkOrderPriority').value = data.priority || 'medium';
                
                updateWorkOrderTracksList();
                updateWorkOrderStatistics();
            }
        }
        
        // Save work order data to localStorage
        function saveWorkOrderData() {
            const data = {
                tracks: enhancedWorkOrderTracks,
                status: currentWorkOrderStatus,
                type: document.getElementById('popupWorkOrderType').value,
                title: document.getElementById('popupWorkOrderTitle').value,
                description: document.getElementById('popupWorkOrderDescription').value,
                priority: document.getElementById('popupWorkOrderPriority').value,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('enhancedWorkOrderData', JSON.stringify(data));
        }
        
        // Auto-save work order data every 30 seconds
        function startAutoSave() {
            setInterval(() => {
                if (document.getElementById('workOrderPopup').classList.contains('active')) {
                    saveWorkOrderData();
                    console.log('🔄 Auto-saved work order data');
                }
            }, 30000); // 30 seconds
        }
        
        // Initialize auto-save on page load
        if (typeof window !== 'undefined') {
            window.addEventListener('load', startAutoSave);
        }
        
        // Add track to enhanced work order
        function addToEnhancedWorkOrder(trackData) {
            const trackId = `${trackData.track}-${trackData.album}`;
            const existingIndex = enhancedWorkOrderTracks.findIndex(t => t.id === trackId);
            
            if (existingIndex < 0) {
                enhancedWorkOrderTracks.push({
                    id: trackId,
                    track: trackData.track,
                    album: trackData.album,
                    artist: trackData.artist,
                    rating: 0,
                    tags: [],
                    notes: '',
                    playCount: 0,
                    addedAt: new Date().toISOString()
                });
                
                updateWorkOrderTracksList();
                updateWorkOrderStatistics();
                saveWorkOrderData();
                showNotification(`Added "${trackData.track}" to work order`, 'success');
            } else {
                showNotification(`"${trackData.track}" is already in work order`, 'warning');
            }
        }
        
        // Update work order tracks list
        function updateWorkOrderTracksList() {
            const container = document.getElementById('workOrderTracksList');
            
            if (enhancedWorkOrderTracks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #888; padding: 40px;">No tracks selected. Right-click on tracks to add them to this work order.</div>';
                return;
            }
            
            container.innerHTML = enhancedWorkOrderTracks.map(track => `
                <div class="work-order-track-item">
                    <div class="work-order-track-info">
                        <div style="font-weight: 600; color: var(--text-primary);">${track.track}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${track.artist} - ${track.album}</div>
                        <div class="metadata-editor" style="margin-top: 10px;">
                            <div class="metadata-field">
                                <label>Rating</label>
                                <div class="rating-stars" data-track-id="${track.id}">
                                    ${[1,2,3,4,5].map(star => `<span class="rating-star ${star <= track.rating ? 'active' : ''}" onclick="setTrackRating('${track.id}', ${star})">★</span>`).join('')}
                                </div>
                            </div>
                            <div class="metadata-field">
                                <label>Tags</label>
                                <div class="tag-input">
                                    ${track.tags.map(tag => `<span class="tag">${tag}<span class="tag-remove" onclick="removeTag('${track.id}', '${tag}')">×</span></span>`).join('')}
                                    <input type="text" placeholder="Add tag..." onkeypress="addTag(event, '${track.id}')" style="border: none; background: transparent; color: var(--text-primary); outline: none;">
                                </div>
                            </div>
                            <div class="metadata-field">
                                <label>Notes</label>
                                <textarea placeholder="Add notes..." onchange="updateTrackNotes('${track.id}', this.value)" style="width: 100%; height: 60px; border: 1px solid var(--glass-border); background: var(--dark-bg); color: var(--text-primary); border-radius: 4px; padding: 8px;">${track.notes}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="work-order-track-actions">
                        <button class="btn secondary" onclick="playTrackFromWorkOrder('${track.track}', '${track.album}', '${track.artist}')">▶️</button>
                        <button class="btn secondary" onclick="removeFromEnhancedWorkOrder('${track.id}')">🗑️</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Update work order statistics
        function updateWorkOrderStatistics() {
            const trackCount = enhancedWorkOrderTracks.length;
            const totalDuration = enhancedWorkOrderTracks.reduce((sum, track) => sum + (track.duration || 0), 0);
            const avgRating = trackCount > 0 ? enhancedWorkOrderTracks.reduce((sum, track) => sum + track.rating, 0) / trackCount : 0;
            
            document.getElementById('workOrderTrackCount').textContent = trackCount;
            document.getElementById('workOrderDuration').textContent = formatTime(totalDuration);
            document.getElementById('workOrderAvgRating').textContent = avgRating.toFixed(1);
        }
        
        // Set work order status
        function setWorkOrderStatus(status) {
            currentWorkOrderStatus = status;
            
            // Update status badges
            document.querySelectorAll('.status-badge').forEach(badge => {
                badge.classList.remove('status-pending', 'status-in-progress', 'status-completed');
            });
            
            const statusMap = {
                'pending': 'status-pending',
                'in-progress': 'status-in-progress',
                'completed': 'status-completed'
            };
            
            event.target.classList.add(statusMap[status]);
            saveWorkOrderData();
        }
        
        // Set track rating
        function setTrackRating(trackId, rating) {
            const track = enhancedWorkOrderTracks.find(t => t.id === trackId);
            if (track) {
                track.rating = rating;
                updateWorkOrderTracksList();
                updateWorkOrderStatistics();
                saveWorkOrderData();
            }
        }
        
        // Add tag to track
        function addTag(event, trackId) {
            if (event.key === 'Enter') {
                const tag = event.target.value.trim();
                if (tag) {
                    const track = enhancedWorkOrderTracks.find(t => t.id === trackId);
                    if (track && !track.tags.includes(tag)) {
                        track.tags.push(tag);
                        updateWorkOrderTracksList();
                        saveWorkOrderData();
                    }
                    event.target.value = '';
                }
            }
        }
        
        // Remove tag from track
        function removeTag(trackId, tag) {
            const track = enhancedWorkOrderTracks.find(t => t.id === trackId);
            if (track) {
                track.tags = track.tags.filter(t => t !== tag);
                updateWorkOrderTracksList();
                saveWorkOrderData();
            }
        }
        
        // Update track notes
        function updateTrackNotes(trackId, notes) {
            const track = enhancedWorkOrderTracks.find(t => t.id === trackId);
            if (track) {
                track.notes = notes;
                saveWorkOrderData();
            }
        }
        
        // Remove track from enhanced work order
        function removeFromEnhancedWorkOrder(trackId) {
            enhancedWorkOrderTracks = enhancedWorkOrderTracks.filter(t => t.id !== trackId);
            updateWorkOrderTracksList();
            updateWorkOrderStatistics();
            saveWorkOrderData();
            showNotification('Track removed from work order', 'info');
        }
        
        // Play track from work order
        function playTrackFromWorkOrder(trackName, albumName, artistName) {
            // Find the track in catalog data
            const track = catalogData.find(t => 
                t.track === trackName && t.album === albumName && t.artist === artistName
            );
            
            if (track) {
                playTrack(track.file_path, track.track, track.album, track.artist, track.tailscale_echoverse_url, track.api_audio_pathparam);
            } else {
                showNotification('Track not found in catalog', 'error');
            }
        }
        
        // Save work order
        async function saveWorkOrder() {
            const workOrder = {
                type: document.getElementById('popupWorkOrderType').value,
                title: document.getElementById('popupWorkOrderTitle').value,
                description: document.getElementById('popupWorkOrderDescription').value,
                priority: document.getElementById('popupWorkOrderPriority').value,
                status: currentWorkOrderStatus,
                tracks: enhancedWorkOrderTracks,
                createdAt: new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };
            
            try {
                const response = await fetch('/api/work-orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workOrder)
                });
                
                if (response.ok) {
                    showNotification('Work order saved successfully!', 'success');
                    // Clear the work order data
                    enhancedWorkOrderTracks = [];
                    localStorage.removeItem('enhancedWorkOrderData');
                    updateWorkOrderTracksList();
                    updateWorkOrderStatistics();
                } else {
                    showNotification('Error saving work order', 'error');
                }
            } catch (error) {
                console.error('Error saving work order:', error);
                showNotification('Error saving work order', 'error');
            }
        }
    </script>
</body>
</html>
