<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>EchoVerse Music Catalog - Local</title>
    <style>
        body {
            font-family: system-ui, Segoe UI, Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }
        .file-input {
            margin-bottom: 15px;
        }
        .file-input input[type="file"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .search-box {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
        }
        .search-box:focus {
            border-color: #667eea;
        }
        .work-orders {
            margin-top: 15px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.secondary:hover {
            background: #5a6268;
        }
        .content {
            padding: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        .catalog {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .album-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .album-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .album-cover {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }
        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .album-info {
            padding: 20px;
        }
        .album-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .album-artist {
            color: #666;
            margin-bottom: 15px;
        }
        .album-tracks {
            font-size: 0.9em;
            color: #888;
        }
        .track-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .track-item:last-child {
            border-bottom: none;
        }
        .track-name {
            flex: 1;
        }
        .track-duration {
            color: #999;
            font-size: 0.8em;
        }
        .lyrics-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
            max-height: 100px;
            overflow: hidden;
        }
        .lyrics-preview.expanded {
            max-height: none;
        }
        .toggle-lyrics {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 0.8em;
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .instructions {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        
        /* Audio Player */
        .audio-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid #ddd;
            padding: 20px;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .audio-player.active {
            transform: translateY(0);
        }
        
        .player-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
        }
        
        .player-cover {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            overflow: hidden;
        }
        
        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .track-details {
            flex: 1;
        }
        
        .track-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .track-artist {
            font-size: 0.9rem;
            color: #666;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            justify-content: center;
        }
        
        .control-btn {
            background: none;
            border: none;
            color: #333;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .control-btn.play-pause {
            background: #667eea;
            color: white;
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
        }
        
        .control-btn.play-pause:hover {
            background: #5a6fd8;
        }
        
        .progress-container {
            flex: 1;
            max-width: 400px;
            position: relative;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .player-volume {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        
        .volume-progress {
            height: 100%;
            background: #667eea;
            border-radius: 2px;
            width: 70%;
        }
        
        .close-player {
            background: none;
            border: none;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.2s ease;
        }
        
        .close-player:hover {
            color: #333;
        }
        
        /* Enhanced Audio Features */
        .spectrum-analyzer {
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 50%, rgba(102, 126, 234, 0.3) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: end;
            justify-content: center;
            gap: 1px;
        }
        
        .spectrum-analyzer.active {
            opacity: 1;
        }
        
        .spectrum-bar {
            width: 3px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 1px;
            transition: height 0.1s ease;
        }
        
        /* Theme Integration */
        :root {
            --theme-bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            --theme-card-bg: rgba(255, 255, 255, 0.05);
            --theme-border: rgba(255, 255, 255, 0.1);
            --theme-text: #ffffff;
            --theme-highlight: #667eea;
            --theme-selected-bg: rgba(102, 126, 234, 0.2);
            --theme-selected-text: #667eea;
            --theme-button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --theme-button-text: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 EchoVerse Music Catalog</h1>
            <p>Your complete music library with lyrics, covers, and work order management</p>
        </div>
        
        <div class="controls">
            <div class="file-input">
                <input type="file" id="csvFile" accept=".csv" />
                <p><small>Select your inventory CSV file (e.g., _inventory_20250902_022031.csv)</small></p>
            </div>
            
            <input type="text" class="search-box" placeholder="Search albums, artists, tracks, or lyrics..." id="searchBox" disabled />
            
            <div class="work-orders">
                <button class="btn" onclick="createWorkOrder('playlist')" disabled id="playlistBtn">📋 Create Playlist</button>
                <button class="btn" onclick="createWorkOrder('move')" disabled id="moveBtn">📁 Move to Folder</button>
                <button class="btn" onclick="createWorkOrder('next')" disabled id="nextBtn">⏭️ Start Next Album</button>
                <button class="btn secondary" onclick="createWorkOrder('remix')" disabled id="remixBtn">🎛️ Remix Songs</button>
            </div>
        </div>
        
        <div class="content">
            <div class="instructions">
                <strong>📁 How to use:</strong> 
                1. Click "Choose File" above and select your inventory CSV from M:\Albums\ 
                2. The catalog will automatically load and display your music library
                3. Use the search box to find specific albums, tracks, or lyrics
                4. Create work orders for playlists, file moves, and more
            </div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalAlbums">...</div>
                    <div class="stat-label">Total Albums</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTracks">...</div>
                    <div class="stat-label">Total Tracks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalLyrics">...</div>
                    <div class="stat-label">Lyrics Available</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSize">...</div>
                    <div class="stat-label">Total Size</div>
                </div>
            </div>
            
            <div class="catalog" id="catalog">
                <div class="loading">Select a CSV file to load your music catalog</div>
            </div>
        </div>
    </div>

    <!-- Metadata Manager Script -->
    <script src="metadata_manager.js"></script>
    
    <!-- Theme Integration Script -->
    <script src="theme_integration.js"></script>
    
    <!-- Context Menu Script -->
    <script src="context_menu.js"></script>
    
    <!-- Persistent Audio Script -->
    <script src="persistent_audio.js"></script>

    <!-- Audio Player -->
    <div class="audio-player" id="audioPlayer">
        <div class="player-content">
            <div class="player-info">
                <div class="player-cover" id="playerCover">
                    <div>🎵</div>
                </div>
                <div class="track-details">
                    <div class="track-title" id="playerTitle">No track selected</div>
                    <div class="track-artist" id="playerArtist">Select a track to play</div>
                </div>
            </div>
            
            <div class="player-controls">
                <button class="control-btn" id="prevBtn">⏮️</button>
                <button class="control-btn play-pause" id="playPauseBtn">▶️</button>
                <button class="control-btn" id="nextBtn">⏭️</button>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
            </div>
            
            <div class="player-volume">
                <span>🔊</span>
                <div class="volume-slider" id="volumeSlider">
                    <div class="volume-progress" id="volumeProgress"></div>
                </div>
            </div>
            
            <button class="close-player" id="closePlayer">✕</button>
        </div>
        
        <audio id="audioElement" preload="metadata"></audio>
        
        <!-- Spectrum Analyzer -->
        <div id="spectrumAnalyzer" class="spectrum-analyzer"></div>
    </div>

    <script>
        let catalogData = [];
        let filteredData = [];
        
        // File input handler
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadCatalogFromFile(file);
            }
        });
        
        // Load catalog from local file
        function loadCatalogFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    catalogData = parseCSV(csvText);
                    filteredData = [...catalogData];
                    
                    // Enable controls
                    document.getElementById('searchBox').disabled = false;
                    document.getElementById('playlistBtn').disabled = false;
                    document.getElementById('moveBtn').disabled = false;
                    document.getElementById('nextBtn').disabled = false;
                    document.getElementById('remixBtn').disabled = false;
                    
                    // Show stats and catalog
                    document.getElementById('stats').style.display = 'grid';
                    updateStats();
                    renderCatalog();
                    
                } catch (error) {
                    console.error('Error loading catalog:', error);
                    document.getElementById('catalog').innerHTML = '<div class="error">Failed to load catalog: ' + error.message + '</div>';
                }
            };
            reader.readAsText(file);
        }
        
        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                    });
                    data.push(row);
                }
            }
            return data;
        }
        
        // Update statistics
        function updateStats() {
            const albums = new Set(catalogData.filter(row => row.album).map(row => row.album));
            const tracks = catalogData.filter(row => row.track).length;
            const lyrics = catalogData.filter(row => row.lyrics_file).length;
            const totalSize = catalogData.reduce((sum, row) => sum + (parseInt(row.file_size || 0) || 0), 0);
            
            document.getElementById('totalAlbums').textContent = albums.size;
            document.getElementById('totalTracks').textContent = tracks;
            document.getElementById('totalLyrics').textContent = lyrics;
            document.getElementById('totalSize').textContent = formatBytes(totalSize);
        }
        
        // Format bytes to human readable
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Render catalog
        function renderCatalog() {
            const container = document.getElementById('catalog');
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">No albums found</div>';
                return;
            }
            
            // Group by album
            const albums = {};
            filteredData.forEach(row => {
                if (row.album && row.track) {
                    if (!albums[row.album]) {
                        albums[row.album] = {
                            album: row.album,
                            artist: row.artist || 'Unknown Artist',
                            tracks: [],
                            cover: row.cover_file || '',
                            lyrics: row.lyrics_file || ''
                        };
                    }
                    albums[row.album].tracks.push({
                        track: row.track,
                        duration: row.duration || '',
                        file: row.file_path || '',
                        lyrics: row.lyrics_file || ''
                    });
                }
            });
            
            container.innerHTML = Object.values(albums).map(album => `
                <div class="album-card">
                    <div class="album-cover">
                        ${album.cover ? `<img src="file:///${album.cover.replace(/\\/g, '/')}" alt="${album.album}" />` : `<div>🎵</div>`}
                    </div>
                    <div class="album-info">
                        <div class="album-title">${album.album}</div>
                        <div class="album-artist">${album.artist}</div>
                        <div class="album-tracks">
                            ${album.tracks.map((track, index) => `
                                <div class="track-item" oncontextmenu="showTrackContextMenu(event, '${album.album}', '${album.artist}', '${track.track}', '${track.duration}', '${album.cover || ''}', ${index})">
                                    <span class="track-name">${track.track}</span>
                                    <span class="track-duration">${track.duration}</span>
                                    <button class="control-btn" onclick="playTrack('${album.album}', '${album.artist}', '${track.track}', '${track.duration}', '${album.cover || ''}', ${index})" style="font-size: 0.8rem; padding: 4px;">▶️</button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="album-actions" style="margin-top: 15px;">
                            <button class="btn" onclick="playAlbum('${album.album}', '${album.artist}', '${album.cover || ''}')">🎵 Play Album</button>
                        </div>
                        ${album.lyrics ? `
                            <div class="lyrics-preview" id="lyrics-${album.album.replace(/[^a-zA-Z0-9]/g, '')}">
                                <strong>Lyrics Preview:</strong> ${album.lyrics.substring(0, 100)}...
                                <button class="toggle-lyrics" onclick="toggleLyrics('${album.album.replace(/[^a-zA-Z0-9]/g, '')}')">Show More</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Toggle lyrics display
        function toggleLyrics(albumId) {
            const lyricsDiv = document.getElementById(`lyrics-${albumId}`);
            const button = lyricsDiv.querySelector('.toggle-lyrics');
            if (lyricsDiv.classList.contains('expanded')) {
                lyricsDiv.classList.remove('expanded');
                button.textContent = 'Show More';
            } else {
                lyricsDiv.classList.add('expanded');
                button.textContent = 'Show Less';
            }
        }
        
        // Search functionality
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            if (query.trim() === '') {
                filteredData = [...catalogData];
            } else {
                filteredData = catalogData.filter(row => {
                    return (row.album && row.album.toLowerCase().includes(query)) ||
                           (row.artist && row.artist.toLowerCase().includes(query)) ||
                           (row.track && row.track.toLowerCase().includes(query)) ||
                           (row.lyrics_file && row.lyrics_file.toLowerCase().includes(query));
                });
            }
            updateStats();
            renderCatalog();
        });
        
        // Work order functions
        function createWorkOrder(type) {
            const selectedAlbums = prompt(`Enter album names for ${type} (comma-separated):`);
            if (selectedAlbums) {
                const workOrder = {
                    type: type,
                    albums: selectedAlbums.split(',').map(a => a.trim()),
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };
                
                // Save work order to localStorage for now
                const existingOrders = JSON.parse(localStorage.getItem('workOrders') || '[]');
                existingOrders.push(workOrder);
                localStorage.setItem('workOrders', JSON.stringify(existingOrders));
                
                console.log('Work Order Created:', workOrder);
                alert(`Work order created for ${type}: ${selectedAlbums}\n\nSaved to browser storage. You can implement file saving later.`);
            }
        }
        
        // Load any existing work orders on page load
        window.addEventListener('load', function() {
            const existingOrders = JSON.parse(localStorage.getItem('workOrders') || '[]');
            if (existingOrders.length > 0) {
                console.log('Existing work orders:', existingOrders);
            }
        });
        
        // Audio Player Functionality
        let currentTrack = null;
        let currentAlbum = null;
        let currentTrackIndex = 0;
        let isPlaying = false;
        let audioContext = null;
        let analyser = null;
        let gainNode = null;
        let bassFilter = null;
        let trebleFilter = null;
        let reverbNode = null;
        let source = null;
        let spectrumBars = [];
        let animationId = null;
        
        const audioElement = document.getElementById('audioElement');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeProgress = document.getElementById('volumeProgress');
        const closePlayer = document.getElementById('closePlayer');
        
        // Initialize audio player
        function initAudioPlayer() {
            // Set initial volume
            audioElement.volume = 0.7;
            updateVolumeDisplay();
            
            // Initialize Web Audio API
            initializeAudioContext();
            
            // Event listeners
            playPauseBtn.addEventListener('click', togglePlayPause);
            progressBar.addEventListener('click', seekTo);
            volumeSlider.addEventListener('click', setVolume);
            closePlayer.addEventListener('click', hidePlayer);
            
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('loadedmetadata', updateDuration);
            audioElement.addEventListener('ended', playNext);
            audioElement.addEventListener('play', startSpectrumAnalyzer);
            audioElement.addEventListener('pause', stopSpectrumAnalyzer);
        }
        
        // Initialize Web Audio API
        function initializeAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                gainNode = audioContext.createGain();
                bassFilter = audioContext.createBiquadFilter();
                trebleFilter = audioContext.createBiquadFilter();
                reverbNode = audioContext.createConvolver();
                
                // Configure analyser
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;
                
                // Configure filters
                bassFilter.type = 'lowshelf';
                bassFilter.frequency.setValueAtTime(250, audioContext.currentTime);
                bassFilter.gain.setValueAtTime(0, audioContext.currentTime);
                
                trebleFilter.type = 'highshelf';
                trebleFilter.frequency.setValueAtTime(4000, audioContext.currentTime);
                trebleFilter.gain.setValueAtTime(0, audioContext.currentTime);
                
                // Create reverb impulse
                createReverbImpulse();
                
                // Connect audio graph
                connectAudioToProcessor();
                
            } catch (error) {
                console.error('Web Audio API not supported:', error);
            }
        }
        
        // Create reverb impulse response
        function createReverbImpulse() {
            const length = audioContext.sampleRate * 2;
            const impulse = audioContext.createBuffer(2, length, audioContext.sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
                }
            }
            
            reverbNode.buffer = impulse;
        }
        
        // Connect audio graph
        function connectAudioToProcessor() {
            if (audioContext && analyser) {
                if (source) {
                    source.disconnect();
                }
                source = audioContext.createMediaElementSource(audioElement);
                source.connect(analyser);
                analyser.connect(gainNode);
                gainNode.connect(bassFilter);
                bassFilter.connect(trebleFilter);
                trebleFilter.connect(reverbNode);
                reverbNode.connect(audioContext.destination);
            }
        }
        
        // Start spectrum analyzer
        function startSpectrumAnalyzer() {
            if (!analyser) return;
            
            const spectrumContainer = document.getElementById('spectrumAnalyzer');
            if (!spectrumContainer) return;
            
            // Clear existing bars
            spectrumContainer.innerHTML = '';
            spectrumBars = [];
            
            // Create spectrum bars
            const barCount = 32;
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'spectrum-bar';
                bar.style.cssText = `
                    width: 3px;
                    background: linear-gradient(to top, #667eea, #764ba2);
                    border-radius: 1px;
                    transition: height 0.1s ease;
                `;
                spectrumContainer.appendChild(bar);
                spectrumBars.push(bar);
            }
            
            // Show spectrum analyzer
            spectrumContainer.classList.add('active');
            
            // Start animation
            animateSpectrum();
        }
        
        // Stop spectrum analyzer
        function stopSpectrumAnalyzer() {
            const spectrumContainer = document.getElementById('spectrumAnalyzer');
            if (spectrumContainer) {
                spectrumContainer.classList.remove('active');
            }
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }
        
        // Animate spectrum analyzer
        function animateSpectrum() {
            if (!analyser || !isPlaying) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            // Update spectrum bars
            spectrumBars.forEach((bar, index) => {
                const value = dataArray[Math.floor(index * bufferLength / spectrumBars.length)];
                const height = Math.max(2, (value / 255) * 20);
                bar.style.height = `${height}px`;
            });
            
            animationId = requestAnimationFrame(() => animateSpectrum());
        }
        
        // Set bass level
        function setBass(value) {
            if (bassFilter) {
                bassFilter.gain.setValueAtTime(value, audioContext.currentTime);
            }
        }
        
        // Set treble level
        function setTreble(value) {
            if (trebleFilter) {
                trebleFilter.gain.setValueAtTime(value, audioContext.currentTime);
            }
        }
        
        // Set reverb level
        function setReverb(value) {
            if (reverbNode) {
                reverbNode.gain = value;
            }
        }
        
        // Enhance audio quality
        function enhanceAudioQuality() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // Apply optimal settings
            setBass(2);
            setTreble(1);
            setReverb(0.3);
            
            console.log('Audio quality enhanced');
        }
        
        // Play a specific track
        function playTrack(album, artist, track, duration, cover, trackIndex) {
            currentTrack = { album, artist, track, duration, cover, trackIndex };
            currentAlbum = album;
            currentTrackIndex = trackIndex;
            
            // Update player display
            document.getElementById('playerTitle').textContent = track;
            document.getElementById('playerArtist').textContent = `${artist} - ${album}`;
            
            // Update cover
            const playerCover = document.getElementById('playerCover');
            if (cover) {
                playerCover.innerHTML = `<img src="file:///${cover.replace(/\\/g, '/')}" alt="${album}" />`;
            } else {
                playerCover.innerHTML = '<div>🎵</div>';
            }
            
            // Try to use the actual file path from the CSV data
            const trackData = catalogData.find(row => 
                row.album === album && row.track === track
            );
            
            let audioPath;
            if (trackData && trackData.full_path) {
                audioPath = `file:///${trackData.full_path.replace(/\\/g, '/')}`;
                audioElement.src = audioPath;
            } else {
                // Fallback path
                audioPath = `file:///M:/Albums/${album}/${track}.mp3`;
                audioElement.src = audioPath;
            }
            
            // Connect to enhanced audio processing
            connectAudioToProcessor();
            
            // Show player and try to play
            showPlayer();
            audioElement.play().then(() => {
                isPlaying = true;
                playPauseBtn.textContent = '⏸️';
                startSpectrumAnalyzer();
                enhanceAudioQuality();
            }).catch(error => {
                console.log('Could not play audio file:', error);
                // For demo, show a message
                document.getElementById('playerTitle').textContent = `${track} (Demo - File not accessible)`;
            });
            
            // Also play in persistent audio system
            if (typeof persistentAudio !== 'undefined' && persistentAudio) {
                const persistentTrackData = {
                    track: track,
                    artist: artist,
                    album: album,
                    duration: duration,
                    cover: cover,
                    trackIndex: trackIndex,
                    src: audioPath
                };
                persistentAudio.playTrack(persistentTrackData);
            }
            
            // Track play count in metadata
            if (typeof metadataManager !== 'undefined' && metadataManager) {
                const songId = metadataManager.generateSongId(track, duration, Date.now());
                metadataManager.incrementPlayCount(songId);
            }
        }
        
        // Play entire album
        function playAlbum(album, artist, cover) {
            const albums = {};
            catalogData.forEach(row => {
                if (row.album && row.track) {
                    if (!albums[row.album]) {
                        albums[row.album] = {
                            album: row.album,
                            artist: row.artist || 'Unknown Artist',
                            tracks: [],
                            cover: row.cover_file || '',
                            lyrics: row.lyrics_file || ''
                        };
                    }
                    albums[row.album].tracks.push({
                        track: row.track,
                        duration: row.duration || '',
                        file: row.file_path || '',
                        lyrics: row.lyrics_file || ''
                    });
                }
            });
            
            const albumData = albums[album];
            if (albumData && albumData.tracks.length > 0) {
                playTrack(album, artist, albumData.tracks[0].track, albumData.tracks[0].duration, cover, 0);
            }
        }
        
        // Toggle play/pause
        function togglePlayPause() {
            if (isPlaying) {
                audioElement.pause();
                isPlaying = false;
                playPauseBtn.textContent = '▶️';
            } else {
                audioElement.play().then(() => {
                    isPlaying = true;
                    playPauseBtn.textContent = '⏸️';
                }).catch(error => {
                    console.log('Could not play audio:', error);
                });
            }
        }
        
        // Play next track
        function playNext() {
            if (currentAlbum) {
                const albums = {};
                catalogData.forEach(row => {
                    if (row.album && row.track) {
                        if (!albums[row.album]) {
                            albums[row.album] = {
                                album: row.album,
                                artist: row.artist || 'Unknown Artist',
                                tracks: [],
                                cover: row.cover_file || '',
                                lyrics: row.lyrics_file || ''
                            };
                        }
                        albums[row.album].tracks.push({
                            track: row.track,
                            duration: row.duration || '',
                            file: row.file_path || '',
                            lyrics: row.lyrics_file || ''
                        });
                    }
                });
                
                const albumData = albums[currentAlbum];
                if (albumData && currentTrackIndex < albumData.tracks.length - 1) {
                    const nextTrack = albumData.tracks[currentTrackIndex + 1];
                    playTrack(currentAlbum, albumData.artist, nextTrack.track, nextTrack.duration, albumData.cover, currentTrackIndex + 1);
                }
            }
        }
        
        // Update progress bar
        function updateProgress() {
            if (audioElement.duration) {
                const progressPercent = (audioElement.currentTime / audioElement.duration) * 100;
                progress.style.width = progressPercent + '%';
                currentTimeEl.textContent = formatTime(audioElement.currentTime);
            }
        }
        
        // Update duration display
        function updateDuration() {
            durationEl.textContent = formatTime(audioElement.duration);
        }
        
        // Seek to position
        function seekTo(e) {
            if (audioElement.duration) {
                const rect = progressBar.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const width = rect.width;
                const clickPercent = clickX / width;
                audioElement.currentTime = clickPercent * audioElement.duration;
            }
        }
        
        // Set volume
        function setVolume(e) {
            const rect = volumeSlider.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const volume = Math.max(0, Math.min(1, clickX / width));
            
            audioElement.volume = volume;
            updateVolumeDisplay();
        }
        
        // Update volume display
        function updateVolumeDisplay() {
            const volumePercent = audioElement.volume * 100;
            volumeProgress.style.width = volumePercent + '%';
        }
        
        // Format time
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Show player
        function showPlayer() {
            audioPlayer.classList.add('active');
        }
        
        // Hide player
        function hidePlayer() {
            audioPlayer.classList.remove('active');
            audioElement.pause();
            isPlaying = false;
            playPauseBtn.textContent = '▶️';
        }
        
        // Context menu function for tracks
        function showTrackContextMenu(event, album, artist, track, duration, cover, trackIndex) {
            event.preventDefault();
            const songData = {
                track: track,
                artist: artist,
                album: album,
                duration: duration,
                cover: cover,
                trackIndex: trackIndex
            };
            
            if (typeof contextMenu !== 'undefined' && contextMenu) {
                contextMenu.showSongMenu(event, songData);
            }
        }
        
        // Initialize player when page loads
        window.addEventListener('DOMContentLoaded', function() {
            initAudioPlayer();
            // Initialize theme integration
            if (typeof initializeThemeIntegration === 'function') {
                initializeThemeIntegration();
            }
            // Initialize context menu
            if (typeof initializeContextMenu === 'function') {
                initializeContextMenu();
            }
            // Initialize persistent audio
            if (typeof initializePersistentAudio === 'function') {
                initializePersistentAudio();
            }
        });
    </script>
</body>
</html>
